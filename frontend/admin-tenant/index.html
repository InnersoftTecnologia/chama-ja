<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin do Tenant ‚Äî Chamador</title>
    <link rel="icon" href="data:," />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
      /* Light/Dark toggle (Bootstrap 5.3 color modes) */
      :root {
        --scart-primary: #2f5fa7;
        --scart-accent: #00a7c7;
        --scart-bg: #f5f7fb;

        /* SCart (AmLic) pastel palette / shadows (from viewTitulo.php reference) */
        --amlic-blue: #52658C;
        --amlic-blue-secondary: #4A5A7A;
        --amlic-orange: #F39C12;
        --primary-color: var(--amlic-blue);
        --primary-gradient: linear-gradient(135deg, var(--amlic-blue) 0%, var(--amlic-blue-secondary) 100%);
        --bg-primary: #f8f9fa;
        --bg-secondary: #ffffff;
        --text-primary: #2c3e50;
        --text-secondary: #6c757d;
        --border-color: #e9ecef;
        --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.08);
        --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.12);
        --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.15);
      }
      [data-bs-theme="dark"] body {
        background: radial-gradient(1200px 600px at 20% 20%, rgba(0, 167, 199, 0.14), transparent 60%),
          radial-gradient(900px 500px at 80% 30%, rgba(47, 95, 167, 0.18), transparent 55%),
          #060816;
      }
      [data-bs-theme="light"] body {
        background: var(--scart-bg);
      }
      body {
        font-family: "Montserrat", system-ui, -apple-system, "Segoe UI", Roboto, Ubuntu, Cantarell, "Noto Sans", "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      }
      .card-glass {
        background: rgba(255, 255, 255, 0.06);
        border: 1px solid rgba(255, 255, 255, 0.12);
        backdrop-filter: blur(10px);
      }
      [data-bs-theme="light"] .card-glass {
        background: #ffffff;
        border-color: rgba(0, 0, 0, 0.08);
      }
      .brand-primary {
        color: var(--scart-primary);
      }
      pre {
        max-height: 320px;
      }
      .sidebar {
        min-width: 260px;
      }

      /* ===== Topbar (AmLic Blue) ===== */
      .navbar-amlic {
        background: var(--primary-gradient);
        border-bottom: none !important;
      }
      .navbar-amlic .navbar-brand {
        color: #fff;
        font-weight: 700;
      }
      .navbar-logo-chamaja {
        height: 36px;
        width: auto;
        display: block;
        object-fit: contain;
      }
      .navbar-amlic .btn-theme-toggle {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: #fff;
        font-size: 0.8rem;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        transition: all 0.2s ease;
      }
      .navbar-amlic .btn-theme-toggle:hover {
        background: rgba(255, 255, 255, 0.25);
        color: #fff;
      }

      /* ===== Footer (SCart style) ===== */
      .footer-innersoft {
        background: var(--primary-gradient);
        color: rgba(255, 255, 255, 0.85);
        padding: 1rem 0;
        margin-top: auto;
        font-size: 0.8rem;
      }
      .footer-innersoft a {
        color: #fff;
        text-decoration: none;
      }
      .footer-innersoft a:hover {
        text-decoration: underline;
      }
      .footer-innersoft .footer-logo {
        height: 28px;
        width: auto;
      }
      .footer-innersoft .footer-divider {
        width: 1px;
        height: 20px;
        background: rgba(255, 255, 255, 0.3);
        margin: 0 1rem;
      }
      /* Layout wrapper para footer fixo no rodap√© */
      body {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }
      .main-content {
        flex: 1;
      }

      /* ===== Tab Navigation (SCart style - AmLic Blue) ===== */
      .nav-tabs-scart {
        border-bottom: 2px solid var(--amlic-blue);
        gap: 4px;
        flex-wrap: nowrap;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: thin;
      }
      .nav-tabs-scart::-webkit-scrollbar {
        height: 4px;
      }
      .nav-tabs-scart::-webkit-scrollbar-thumb {
        background: rgba(82, 101, 140, 0.3);
        border-radius: 2px;
      }
      .nav-tabs-scart .nav-link {
        border: none;
        border-radius: 8px 8px 0 0;
        padding: 12px 20px;
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--amlic-blue);
        background: rgba(82, 101, 140, 0.08);
        transition: all 0.2s ease;
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .nav-tabs-scart .nav-link:hover {
        background: rgba(82, 101, 140, 0.15);
        color: var(--amlic-blue);
      }
      .nav-tabs-scart .nav-link.active {
        background: var(--amlic-blue);
        color: #fff;
        box-shadow: 0 -2px 8px rgba(82, 101, 140, 0.25);
      }
      .nav-tabs-scart .nav-link .tab-icon {
        font-size: 1.1rem;
      }
      /* Modo light: abas inativas mais vis√≠veis (texto e borda mais escuros) */
      [data-bs-theme="light"] .nav-tabs-scart .nav-link:not(.active) {
        color: #2c3e50;
        background: rgba(82, 101, 140, 0.12);
        border: 1px solid rgba(82, 101, 140, 0.22);
      }
      [data-bs-theme="light"] .nav-tabs-scart .nav-link:not(.active):hover {
        background: rgba(82, 101, 140, 0.18);
        color: #1a2332;
        border-color: rgba(82, 101, 140, 0.35);
      }
      [data-bs-theme="dark"] .nav-tabs-scart {
        border-bottom-color: rgba(82, 101, 140, 0.5);
      }
      [data-bs-theme="dark"] .nav-tabs-scart .nav-link {
        color: rgba(255, 255, 255, 0.75);
        background: rgba(255, 255, 255, 0.06);
      }
      [data-bs-theme="dark"] .nav-tabs-scart .nav-link:hover {
        background: rgba(255, 255, 255, 0.12);
        color: #fff;
      }
      [data-bs-theme="dark"] .nav-tabs-scart .nav-link.active {
        background: var(--amlic-blue);
        color: #fff;
      }
      .tab-content-scart {
        padding-top: 1.5rem;
      }
      .tab-pane {
        animation: fadeInTab 0.25s ease;
      }
      @keyframes fadeInTab {
        from { opacity: 0; transform: translateY(8px); }
        to { opacity: 1; transform: translateY(0); }
      }

      /* Estado inicial: abas desabilitadas at√© login */
      #adminTabs {
        pointer-events: none;
        opacity: 0.5;
      }
      #adminTabsContent {
        opacity: 0.4;
        pointer-events: none;
      }
      /* Ap√≥s login, JS habilita (inline styles) */

      /* Login modal layout (SCart-ish, like provided model) */
      .login-modal .modal-content {
        overflow: hidden;
        border: 0;
        border-radius: 14px;
      }
      .login-hero {
        /* Fundo azul bem clarinho (quase branco), no padr√£o AmLic/SCart */
        background: linear-gradient(135deg, rgba(82, 101, 140, 0.12), rgba(0, 167, 199, 0.10));
        background-color: #f6f8ff;
        color: var(--text-primary);
        min-height: 100%;
        position: relative;
      }
      .login-hero::before {
        content: "";
        position: absolute;
        inset: 0;
        background:
          radial-gradient(650px 350px at 20% 25%, rgba(82,101,140,0.10), transparent 55%),
          radial-gradient(650px 350px at 80% 70%, rgba(0,167,199,0.12), transparent 60%);
        pointer-events: none;
      }
      .login-hero-inner {
        position: relative;
        z-index: 1;
      }
      .login-title {
        font-size: clamp(1.6rem, 2.6vw, 2.2rem);
        letter-spacing: -0.02em;
      }
      .login-tenant-logo {
        height: 40px;
        width: auto;
        object-fit: contain;
      }
      .login-hero-logo {
        max-width: min(320px, 80%);
        height: auto;
        filter: drop-shadow(0 10px 18px rgba(0,0,0,0.10));
      }
      .login-hero-logo-innersoft {
        max-width: min(180px, 50%);
        opacity: 0.9;
      }
      .login-hero-three-logos {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        min-height: 280px;
      }
      .login-logo-center {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem 0;
      }
      .login-logo-tenant {
        max-width: min(280px, 85%);
        max-height: 140px;
        width: auto;
        height: auto;
        object-fit: contain;
        filter: drop-shadow(0 8px 20px rgba(0,0,0,0.12));
      }
      .login-logo-bottom-row {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        width: 100%;
        gap: 1rem;
        padding-top: 1rem;
      }
      .login-logo-discreet { text-align: center; opacity: 0.85; }
      .login-logo-chamaja-wrap .login-logo-chamaja {
        height: 32px;
        width: auto;
        object-fit: contain;
      }
      .login-logo-innersoft-wrap .login-hero-logo-innersoft {
        max-width: 120px;
        height: auto;
        object-fit: contain;
      }

      /* Branding upload area (like screenshot) */
      .branding-grid {
        display: grid;
        grid-template-columns: 1.3fr 0.7fr;
        gap: 16px;
      }
      @media (max-width: 992px) {
        .branding-grid { grid-template-columns: 1fr; }
      }
      .preview-box {
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.10);
        background: rgba(255, 255, 255, 0.85);
        min-height: 110px;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 14px;
      }
      [data-bs-theme="dark"] .preview-box {
        border-color: rgba(255, 255, 255, 0.14);
        background: rgba(0, 0, 0, 0.22);
      }
      .btn-h44 .btn { height: 44px; }

      /* ===== SCart-style components (scoped) ===== */
      .scart-card {
        border-radius: 16px;
        box-shadow: var(--shadow-medium);
        border: 1px solid var(--border-color);
        background: var(--bg-secondary);
      }
      [data-bs-theme="dark"] .scart-card {
        background: rgba(255, 255, 255, 0.06);
        border-color: rgba(255, 255, 255, 0.12);
      }
      .card-header-gradient {
        background: var(--primary-gradient) !important;
        padding: 1.25rem 1.5rem !important;
        border-radius: 16px 16px 0 0 !important;
        border: none;
        position: relative;
        overflow: hidden;
        color: #fff;
      }
      .card-header-gradient::before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(243, 156, 18, 0.15) 0%, transparent 70%);
        border-radius: 50%;
        transform: translate(30%, -30%);
      }
      .card-header-gradient * { position: relative; z-index: 1; }
      .card-header-gradient .icon-accent { color: var(--amlic-orange); }
      /* Modo light: bot√µes no header com contraste forte (fundo mais escuro, texto branco) */
      [data-bs-theme="light"] .card-header-gradient .btn-action {
        color: #fff !important;
        border: 1px solid rgba(255, 255, 255, 0.35);
      }
      [data-bs-theme="light"] .card-header-gradient .btn-action.btn-refresh {
        background: linear-gradient(135deg, #1a5276, #154360) !important;
      }
      [data-bs-theme="light"] .card-header-gradient .btn-action.btn-new {
        background: linear-gradient(135deg, #d68910, #b7950b) !important;
      }
      [data-bs-theme="light"] .card-header-gradient .btn-action.btn-delete {
        background: linear-gradient(135deg, #c53030, #9b2c2c) !important;
      }
      [data-bs-theme="light"] .card-header-gradient .btn-action:hover {
        filter: brightness(1.12);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .scart-section-title {
        color: var(--text-primary);
        font-weight: 700;
        font-size: 0.95rem;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.6rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      .scart-section-title::before {
        content: '';
        width: 3px;
        height: 18px;
        background: var(--primary-color);
        border-radius: 2px;
      }

      .scart-input.form-control,
      .scart-input.form-select,
      .scart-input textarea.form-control {
        border: 2px solid #d1d9e6 !important;
        border-radius: 10px;
        padding: 0.6rem 0.8rem;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      }
      .scart-input.form-control:focus,
      .scart-input.form-select:focus,
      .scart-input textarea.form-control:focus {
        border-color: var(--amlic-blue) !important;
        box-shadow: 0 0 0 0.2rem rgba(82, 101, 140, 0.15);
        background: #FFFACD !important; /* pastel yellow */
      }
      [data-bs-theme="dark"] .scart-input.form-control,
      [data-bs-theme="dark"] .scart-input.form-select,
      [data-bs-theme="dark"] .scart-input textarea.form-control {
        background: rgba(0,0,0,0.20);
        border-color: rgba(255,255,255,0.16) !important;
        color: #fff;
      }
      [data-bs-theme="dark"] .scart-input.form-control:focus,
      [data-bs-theme="dark"] .scart-input.form-select:focus,
      [data-bs-theme="dark"] .scart-input textarea.form-control:focus {
        background: rgba(255, 250, 205, 0.14) !important;
      }

      .btn-scart-primary {
        background: var(--primary-gradient);
        color: #fff;
        border: none;
        border-radius: 25px;
        font-weight: 600;
        padding: 10px 18px;
        box-shadow: 0 4px 15px rgba(82, 101, 140, 0.25);
      }
      .btn-scart-primary:hover { transform: translateY(-1px); color:#fff; }
      .btn-scart-secondary {
        background: #6c757d;
        color: #fff;
        border: none;
        border-radius: 25px;
        padding: 10px 18px;
      }
      .btn-scart-secondary:hover { transform: translateY(-1px); color:#fff; }

      .btn-action {
        border-radius: 20px;
        padding: 8px 14px;
        font-size: 12px;
        font-weight: 700;
        border: none;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      .btn-action:hover { transform: translateY(-1px); box-shadow: 0 6px 18px rgba(0,0,0,0.16); }
      .btn-action.btn-delete { background: linear-gradient(135deg, #e53e3e, #c53030); color: #fff; }
      .btn-action.btn-refresh { background: linear-gradient(135deg, #3498db, #2980b9); color: #fff; }
      .btn-action.btn-new { background: linear-gradient(135deg, #f39c12, #e67e22); color: #fff; }
      .btn-action.btn-toggle-on { background: linear-gradient(135deg, #48bb78, #38a169); color: #fff; }
      .btn-action.btn-toggle-off { background: linear-gradient(135deg, #a0aec0, #718096); color: #fff; }
      /* Single toggle button: ativo = verde/primary, inativo = cinza ‚Äî light e dark */
      .tv-toggle-btn.btn-toggle-on { background: linear-gradient(135deg, #48bb78, #38a169); color: #fff; border: 1px solid rgba(56,161,105,0.5); }
      .tv-toggle-btn.btn-toggle-off { background: linear-gradient(135deg, #a0aec0, #718096); color: #fff; border: 1px solid rgba(113,128,150,0.4); }
      [data-bs-theme="dark"] .tv-toggle-btn.btn-toggle-on { background: linear-gradient(135deg, #38a169, #2f855a); color: #fff; border-color: rgba(72,187,120,0.4); }
      [data-bs-theme="dark"] .tv-toggle-btn.btn-toggle-off { background: linear-gradient(135deg, #4a5568, #2d3748); color: rgba(255,255,255,0.85); border-color: rgba(255,255,255,0.15); }
      .btn-action.btn-filter-active { background: linear-gradient(135deg, var(--scart-primary), #1e3f73); color: #fff; }
      .btn-action:not(.btn-filter-active) { background: rgba(0, 0, 0, 0.1); color: var(--text-secondary); }
      [data-bs-theme="dark"] .btn-action:not(.btn-filter-active) { background: rgba(255, 255, 255, 0.1); color: rgba(255, 255, 255, 0.7); }

      .scart-table {
        background: var(--bg-secondary);
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-light);
      }
      [data-bs-theme="dark"] .scart-table {
        background: rgba(0,0,0,0.18);
        box-shadow: none;
      }
      .scart-table table { margin: 0; }
      .scart-table thead th {
        background: rgba(82,101,140,0.10);
        color: var(--text-primary);
        font-weight: 700;
        border-bottom: 1px solid rgba(0,0,0,0.06);
      }
      [data-bs-theme="dark"] .scart-table thead th {
        background: rgba(255,255,255,0.08);
        color: rgba(255,255,255,0.92);
        border-bottom-color: rgba(255,255,255,0.10);
      }
      .scart-table tbody tr:hover { background: rgba(243,156,18,0.08); }
      [data-bs-theme="dark"] .scart-table tbody tr:hover { background: rgba(243,156,18,0.10); }

      .table-scroll {
        max-height: 340px;
        overflow: auto;
      }

      /* Dashboard cards (inspired by provided print) */
      .metric-card {
        background: #fff;
        border-radius: 14px;
        box-shadow: var(--shadow-light);
        border: 1px solid var(--border-color);
        position: relative;
        overflow: hidden;
      }
      [data-bs-theme="dark"] .metric-card {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.12);
        box-shadow: none;
      }
      .metric-card::before {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        bottom: 0;
        width: 4px;
        background: var(--amlic-blue);
      }
      .metric-accent-blue::before { background: #52658C; }
      .metric-accent-orange::before { background: #F39C12; }
      .metric-accent-cyan::before { background: #00a7c7; }
      .metric-accent-green::before { background: #1f9d55; }
      .metric-accent-purple::before { background: #6A4C93; }
      .metric-accent-red::before { background: #e53e3e; }
      .metric-value {
        font-size: 1.8rem;
        font-weight: 800;
        letter-spacing: -0.02em;
      }

      .dash-chart-container { min-height: 200px; }
      .dash-chart-bars {
        display: flex;
        align-items: flex-end;
        gap: 6px;
        height: 180px;
        padding: 10px 0;
      }
      .dash-chart-bar-wrap { flex: 1; display: flex; flex-direction: column; align-items: center; min-width: 0; }
      .dash-chart-bar {
        width: 100%;
        max-width: 32px;
        min-height: 4px;
        background: linear-gradient(180deg, var(--amlic-blue) 0%, var(--amlic-blue-secondary) 100%);
        border-radius: 6px 6px 0 0;
        transition: height 0.3s ease;
      }
      [data-bs-theme="dark"] .dash-chart-bar { background: linear-gradient(180deg, #5a6d9a 0%, #4a5a7a 100%); }
      .dash-chart-bar-wrap .small { font-size: 0.7rem; margin-top: 4px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%; }
      .dash-top-op-row { display: flex; align-items: center; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(0,0,0,0.06); }
      [data-bs-theme="dark"] .dash-top-op-row { border-bottom-color: rgba(255,255,255,0.08); }
      .dash-top-op-row:last-child { border-bottom: none; }
      .dash-top-op-rank { font-weight: 800; color: var(--amlic-blue); margin-right: 8px; min-width: 20px; }
      .dash-top-op-name { flex: 1; overflow: hidden; text-overflow: ellipsis; }
      .dash-top-op-count { font-weight: 700; color: var(--text-primary); }

      /* KPIs estilo Power BI */
      .kpi-card {
        border-radius: 14px;
        overflow: hidden;
        border: 1px solid var(--border-color);
        box-shadow: var(--shadow-light);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
      }
      .kpi-card:hover { transform: translateY(-2px); box-shadow: var(--shadow-medium); }
      [data-bs-theme="dark"] .kpi-card {
        background: rgba(255,255,255,0.06);
        border-color: rgba(255,255,255,0.12);
      }
      .kpi-card-inner { padding: 1rem 1.1rem; position: relative; }
      .kpi-card-inner::before {
        content: "";
        position: absolute;
        left: 0; top: 0; bottom: 0;
        width: 4px;
        border-radius: 4px 0 0 4px;
      }
      .kpi-card-pref .kpi-card-inner::before { background: linear-gradient(180deg, #6A4C93 0%, #8B6BA8 100%); }
      .kpi-card-time-max .kpi-card-inner::before { background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%); }
      .kpi-card-time-min .kpi-card-inner::before { background: linear-gradient(180deg, #1f9d55 0%, #27ae60 100%); }
      .kpi-card-destaque .kpi-card-inner::before { background: linear-gradient(180deg, #F39C12 0%, #e67e22 100%); }
      .kpi-card-maior-qtd .kpi-card-inner::before { background: linear-gradient(180deg, #52658C 0%, #00a7c7 100%); }
      .kpi-card-menor-tempo .kpi-card-inner::before { background: linear-gradient(180deg, #00a7c7 0%, #1abc9c 100%); }
      .kpi-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-secondary); font-weight: 600; margin-bottom: 0.35rem; }
      .kpi-value { font-size: 1.5rem; font-weight: 800; letter-spacing: -0.02em; line-height: 1.2; }
      .kpi-sub { font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem; }
      .kpi-pref-split { display: flex; align-items: stretch; margin-top: 0.5rem; height: 10px; border-radius: 6px; overflow: hidden; background: var(--border-color); }
      [data-bs-theme="dark"] .kpi-pref-split { background: rgba(255,255,255,0.12); }
      .kpi-pref-bar { min-width: 4px; border-radius: 0; transition: flex 0.4s ease; }
      .kpi-pref-bar.pref { background: linear-gradient(90deg, #6A4C93, #8B6BA8); }
      .kpi-pref-bar.norm { background: linear-gradient(90deg, #52658C, #00a7c7); }
      .kpi-pref-legend { display: flex; gap: 1rem; margin-top: 0.4rem; font-size: 0.75rem; }
      .kpi-pref-legend span { display: flex; align-items: center; gap: 0.35rem; }
      .kpi-pref-legend .dot { width: 8px; height: 8px; border-radius: 50%; }
      .kpi-pref-legend .dot.pref { background: #6A4C93; }
      .kpi-pref-legend .dot.norm { background: #52658C; }

      /* Modal (SCart padr√£o visual) */
      .modal-padrao-content {
        border: none;
        border-radius: 20px;
        box-shadow: var(--shadow-heavy);
        overflow: hidden;
      }
      .modal-padrao-header {
        background: var(--primary-gradient);
        color: #fff;
        padding: 18px 22px;
        border: none;
        position: relative;
      }
      .modal-padrao-header::before {
        content: '';
        position: absolute;
        inset: 0;
        background:
          radial-gradient(circle at 20% 20%, rgba(255,255,255,0.14), transparent 45%),
          radial-gradient(circle at 80% 30%, rgba(243,156,18,0.18), transparent 50%);
        opacity: 0.9;
      }
      .modal-padrao-header * { position: relative; z-index: 1; }

      /* SCart-ish soft alerts (pastel) */
      .alert-soft {
        border: 1px solid rgba(0, 0, 0, 0.06);
        background: rgba(47, 95, 167, 0.08);
      }
      [data-bs-theme="dark"] .alert-soft {
        border-color: rgba(255, 255, 255, 0.10);
        background: rgba(0, 167, 199, 0.10);
      }

      /* Make placeholders readable in both themes */
      .form-control::placeholder {
        opacity: 0.7;
      }
      [data-bs-theme="dark"] .form-control,
      [data-bs-theme="dark"] .form-select {
        background-color: rgba(0, 0, 0, 0.28);
        border-color: rgba(255, 255, 255, 0.16);
        color: #fff;
      }
      [data-bs-theme="dark"] .form-control::placeholder {
        color: rgba(255, 255, 255, 0.55);
      }
      [data-bs-theme="dark"] .list-group-item {
        color: rgba(255, 255, 255, 0.82);
      }
      /* Modo light: bot√£o Sair vis√≠vel */
      [data-bs-theme="light"] .btn-outline-secondary {
        color: #495057;
        border-color: #6c757d;
      }
      [data-bs-theme="light"] .btn-outline-secondary:hover {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
      }
    </style>
  </head>
  <body>
    <!-- Login Modal (shown on load when not authenticated) -->
    <div class="modal fade login-modal" id="loginModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-md">
        <div class="modal-content">
          <div class="p-4 p-lg-5">
            <div class="d-flex align-items-center justify-content-between mb-4">
              <div class="fw-bold">Gerenciamento do Chamador</div>
              <img src="images/logo_tenant.png" alt="Ferreira Costa" class="login-tenant-logo" />
            </div>

            <div class="login-title fw-bold mb-1">Acesso ao sistema</div>
            <div class="text-body-secondary mb-4">Acesso do administrador</div>

              <div class="mb-3">
                <label class="form-label">E-mail</label>
                <input id="email" class="form-control" value="admin@ferreiracosta.com.br" autocomplete="username" />
              </div>
              <div class="mb-3">
                <label class="form-label">Senha</label>
                <input id="password" type="password" class="form-control" value="admin123" autocomplete="current-password" />
              </div>

              <div class="d-flex align-items-center justify-content-between mb-3">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" value="" id="rememberMe" checked />
                  <label class="form-check-label" for="rememberMe">Lembrar de mim</label>
                </div>
                <button id="themeToggleInModal" class="btn btn-sm btn-outline-secondary">Light</button>
              </div>

              <div class="d-grid gap-2 btn-h44">
                <button id="btnLogin" class="btn-scart-primary">Entrar</button>
              </div>
              <div id="loginStatus" class="text-body-secondary small mt-3"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Topbar -->
    <nav class="navbar navbar-expand-lg navbar-amlic">
      <div class="container-fluid px-4">
        <div class="d-flex align-items-center gap-3">
          <img src="images/logo_chama_ja.svg" alt="Chama J√°" class="navbar-logo-chamaja" />
          <span class="navbar-brand mb-0">Gerenciamento do Chamador</span>
        </div>
        <div class="d-flex align-items-center gap-3 ms-auto">
          <button id="themeToggle" class="btn btn-theme-toggle">Light</button>
        </div>
      </div>
    </nav>
    <!-- Hidden elements for JS compatibility -->
    <span id="edgeBase" class="d-none"></span>
    <span id="tenantCnpj" class="d-none"></span>
    <button id="btnLogoutTop" class="d-none"></button>

    <div class="main-content">
    <div class="container-fluid px-4 py-4">
      <!-- Header com identifica√ß√£o do tenant -->
      <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap mb-4">
        <div class="d-flex align-items-center gap-3">
          <img id="tenantLogoMini" alt="logo do tenant" style="height:40px; width:auto; display:none" />
          <div>
            <h1 class="fw-bold mb-0 fs-4">Painel de Gest√£o do Chamador</h1>
            <div class="text-body-secondary small">
              <span id="tenantName">-</span> ‚Ä¢ CNPJ: <span id="tenantCnpjFull">-</span> ‚Ä¢ <span id="tenantStatus" class="badge text-bg-light border">-</span>
            </div>
          </div>
        </div>
        <button id="btnLogout" class="btn btn-outline-secondary d-none">Sair</button>
      </div>

      <!-- Tab Navigation -->
      <ul class="nav nav-tabs nav-tabs-scart" id="adminTabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="tab-dashboard" data-bs-toggle="tab" data-bs-target="#pane-dashboard" type="button" role="tab" aria-controls="pane-dashboard" aria-selected="true">
            <span class="tab-icon">üìä</span> Dashboard
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-operators" data-bs-toggle="tab" data-bs-target="#pane-operators" type="button" role="tab" aria-controls="pane-operators" aria-selected="false">
            <span class="tab-icon">üë•</span> Operadores
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-counters" data-bs-toggle="tab" data-bs-target="#pane-counters" type="button" role="tab" aria-controls="pane-counters" aria-selected="false">
            <span class="tab-icon">üè¢</span> Guich√™s
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-services" data-bs-toggle="tab" data-bs-target="#pane-services" type="button" role="tab" aria-controls="pane-services" aria-selected="false">
            <span class="tab-icon">üìã</span> Servi√ßos
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="tab-tv-panel" data-bs-toggle="tab" data-bs-target="#pane-tv-panel" type="button" role="tab" aria-controls="pane-tv-panel" aria-selected="false">
            <span class="tab-icon">üì∫</span> Painel do Chamador
          </button>
        </li>
      </ul>

      <!-- Tab Content -->
      <div class="tab-content tab-content-scart" id="adminTabsContent">

        <!-- Dashboard Tab -->
        <div class="tab-pane fade show active" id="pane-dashboard" role="tabpanel" aria-labelledby="tab-dashboard">
          <div class="d-flex justify-content-end gap-2 mb-2">
            <button type="button" id="btnOpenLiveMonitor" class="btn btn-sm btn-outline-success">Monitor ao Vivo</button>
            <button type="button" id="btnRefreshDashboard" class="btn btn-sm btn-outline-primary">Atualizar indicadores</button>
          </div>
          <div class="row g-3 mb-4">
            <!-- M√©tricas principais -->
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-blue p-3 h-100">
                <div class="small text-body-secondary">Guich√™s</div>
                <div id="dashCounters" class="metric-value mt-1">-</div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-cyan p-3 h-100">
                <div class="small text-body-secondary">Servi√ßos</div>
                <div id="dashServices" class="metric-value mt-1">-</div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-purple p-3 h-100">
                <div class="small text-body-secondary">Operadores</div>
                <div id="dashOperators" class="metric-value mt-1">-</div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-orange p-3 h-100">
                <div class="small text-body-secondary">Em atendimento (60m)</div>
                <div id="dashInService" class="metric-value mt-1">-</div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-green p-3 h-100">
                <div class="small text-body-secondary">Atendidos hoje</div>
                <div id="dashAttendedToday" class="metric-value mt-1">-</div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-lg-2">
              <div class="metric-card metric-accent-blue p-3 h-100">
                <div class="small text-body-secondary">√öltima chamada</div>
                <div id="dashLastCall" class="fw-semibold mt-2" style="font-size: 0.85rem;">-</div>
              </div>
            </div>
          </div>

          <!-- KPIs estilo Power BI (preferenciais, tempos, operador destaque) -->
          <div class="row g-3 mt-1 mb-2">
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-pref h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Preferenciais √ó Normais</div>
                  <div class="kpi-value"><span id="dashKpiPref">0</span> √ó <span id="dashKpiNorm">0</span></div>
                  <div class="kpi-pref-split">
                    <div class="kpi-pref-bar pref" id="dashKpiPrefBar" style="flex: 0 0 0%; max-width: 100%;"></div>
                    <div class="kpi-pref-bar norm" id="dashKpiNormBar" style="flex: 0 0 0%; max-width: 100%;"></div>
                  </div>
                  <div class="kpi-pref-legend">
                    <span><span class="dot pref"></span> Preferencial</span>
                    <span><span class="dot norm"></span> Normal</span>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-time-max h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Maior tempo de atendimento</div>
                  <div class="kpi-value" id="dashKpiMaxTime">‚Äî</div>
                  <div class="kpi-sub">no per√≠odo</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-time-min h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Menor tempo de atendimento</div>
                  <div class="kpi-value" id="dashKpiMinTime">‚Äî</div>
                  <div class="kpi-sub">no per√≠odo</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-destaque h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Operador destaque</div>
                  <div class="kpi-value text-truncate" id="dashKpiTopOpName" title="">‚Äî</div>
                  <div class="kpi-sub"><span id="dashKpiTopOpCount">0</span> atendimentos</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-maior-qtd h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Maior quantidade</div>
                  <div class="kpi-value text-truncate" id="dashKpiMaiorQtdName" title="">‚Äî</div>
                  <div class="kpi-sub"><span id="dashKpiMaiorQtdCount">0</span> conclu√≠dos</div>
                </div>
              </div>
            </div>
            <div class="col-6 col-md-4 col-xl-2">
              <div class="kpi-card kpi-card-menor-tempo h-100">
                <div class="kpi-card-inner h-100">
                  <div class="kpi-label">Menor tempo m√©dio</div>
                  <div class="kpi-value text-truncate" id="dashKpiFastOpName" title="">‚Äî</div>
                  <div class="kpi-sub">m√©dia <span id="dashKpiFastOpAvg">‚Äî</span></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Segunda linha: an√°lise -->
          <div class="row g-4">
            <!-- Atendimentos por per√≠odo -->
            <div class="col-12 col-lg-8">
              <div class="card scart-card h-100">
                <div class="card-header-gradient d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <div>
                    <div class="scart-section-title text-white">Atendimentos por per√≠odo</div>
                    <div class="small opacity-75 mt-1">Quantidade de atendimentos conclu√≠dos por dia.</div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="button" id="dashPeriod7d" class="btn btn-sm btn-outline-light dash-period-btn active">7 dias</button>
                    <button type="button" id="dashPeriod30d" class="btn btn-sm btn-outline-light dash-period-btn">30 dias</button>
                  </div>
                </div>
                <div class="card-body p-4">
                  <div id="dashChartContainer" class="dash-chart-container">
                    <div id="dashChartBars" class="dash-chart-bars"></div>
                  </div>
                  <div id="dashChartEmpty" class="text-body-secondary small text-center py-4 d-none">Nenhum atendimento no per√≠odo.</div>
                </div>
              </div>
            </div>
            <!-- Melhor atendente -->
            <div class="col-12 col-lg-4">
              <div class="card scart-card h-100">
                <div class="card-header-gradient">
                  <div>
                    <div class="scart-section-title text-white">Ranking de atendentes</div>
                    <div class="small opacity-75 mt-1">Quem mais finalizou atendimentos.</div>
                  </div>
                </div>
                <div class="card-body p-4">
                  <div id="dashTopOperatorsList"></div>
                  <button type="button" id="btnOpenRankingModal" class="btn btn-sm btn-outline-primary mt-3 w-100">Ver ranking completo</button>
                </div>
              </div>
            </div>
          </div>

          <!-- √öltimos atendimentos -->
          <div class="row mt-2">
            <div class="col-12">
              <div class="card scart-card">
                <div class="card-header-gradient d-flex align-items-center justify-content-between flex-wrap gap-2">
                  <div>
                    <div class="scart-section-title text-white">√öltimos atendimentos</div>
                    <div class="small opacity-75 mt-1">Senhas finalizadas recentemente.</div>
                  </div>
                  <button type="button" id="btnOpenHistoryModal" class="btn btn-sm btn-outline-light">Ver todos com filtros</button>
                </div>
                <div class="card-body p-0">
                  <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0" id="dashRecentTable">
                      <thead><tr><th>Senha</th><th>Servi√ßo</th><th>Atendente</th><th>Guich√™</th><th class="text-nowrap">Finalizado em</th></tr></thead>
                      <tbody id="dashRecentBody"></tbody>
                    </table>
                  </div>
                  <div id="dashRecentEmpty" class="text-body-secondary small text-center py-4 d-none">Nenhum atendimento recente.</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Operadores Tab -->
        <div class="tab-pane fade" id="pane-operators" role="tabpanel" aria-labelledby="tab-operators">
          <div class="card scart-card">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Operadores</div>
                  <div class="small opacity-75 mt-1">Usu√°rios que realizam chamadas no sistema.</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshUsers" class="btn-action btn-refresh">Atualizar</button>
                  <button id="btnOpenUserModal" class="btn-action btn-new">Novo Operador</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="scart-table">
                <div class="table-responsive">
                  <table class="table table-sm align-middle" id="usersTable"></table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Guich√™s Tab -->
        <div class="tab-pane fade" id="pane-counters" role="tabpanel" aria-labelledby="tab-counters">
          <div class="card scart-card">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Guich√™s</div>
                  <div class="small opacity-75 mt-1">Pontos de atendimento dispon√≠veis.</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshCounters" class="btn-action btn-refresh">Atualizar</button>
                  <button id="btnOpenCounterModal" class="btn-action btn-new">Novo Guich√™</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="scart-table">
                <div class="table-responsive">
                  <table class="table table-sm align-middle" id="countersTable"></table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Servi√ßos Tab -->
        <div class="tab-pane fade" id="pane-services" role="tabpanel" aria-labelledby="tab-services">
          <div class="card scart-card">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Servi√ßos</div>
                  <div class="small opacity-75 mt-1">Filas e tipos de atendimento.</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshServices" class="btn-action btn-refresh">Atualizar</button>
                  <button id="btnOpenServiceModal" class="btn-action btn-new">Novo Servi√ßo</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="scart-table">
                <div class="table-responsive">
                  <table class="table table-sm align-middle" id="servicesTable"></table>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Painel do Chamador Tab -->
        <div class="tab-pane fade" id="pane-tv-panel" role="tabpanel" aria-labelledby="tab-tv-panel">

          <!-- Se√ß√£o: Configura√ß√µes da TV -->
          <div class="card scart-card mb-4">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Configura√ß√µes da TV</div>
                  <div class="small opacity-75 mt-1">Apar√™ncia e comportamento do painel chamador.</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshTVSettings" class="btn-action btn-refresh">Atualizar</button>
                  <button type="button" id="btnResetHistory" class="btn-action btn-delete">Resetar hist√≥rico</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="row g-4">
                <!-- Card: Tema -->
                <div class="col-12 col-lg-6">
                  <div class="border rounded-4 p-3 bg-body-tertiary">
                    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                      <div>
                        <div class="fw-bold">Tema do Painel</div>
                        <div class="text-body-secondary small">Apar√™ncia (cores) do painel TV.</div>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" id="btnThemeToggle" class="btn-action btn-toggle-on tv-toggle-btn" style="min-width: 100px;">Dark</button>
                      </div>
                    </div>
                    <div class="alert alert-soft small mb-0 mt-3">
                      Dica: use <b>Light</b> em ambientes claros e <b>Dark</b> para reduzir brilho em TVs/monitores.
                    </div>
                  </div>
                </div>

                <!-- Card: √Åudio de chamada -->
                <div class="col-12 col-lg-6">
                  <div class="border rounded-4 p-3 bg-body-tertiary">
                    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap">
                      <div>
                        <div class="fw-bold">√Åudio de Chamada</div>
                        <div class="text-body-secondary small">Ativar ou desativar o som quando uma senha √© chamada.</div>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" id="btnAudioToggle" class="btn-action btn-toggle-on tv-toggle-btn" style="min-width: 110px;">Ativado</button>
                      </div>
                    </div>
                    <div class="alert alert-soft small mb-0 mt-3">
                      Se estiver em um local sens√≠vel a ru√≠dos, desative e use apenas o destaque visual.
                    </div>
                  </div>
                </div>

                <!-- Linha √∫nica: 3 colunas ‚Äî Som da chamada | √Åudio do v√≠deo | Reprodu√ß√£o do v√≠deo -->
                <div class="row g-4 mb-4">
                  <!-- Card: Som da chamada -->
                  <div class="col-12 col-md-4">
                    <div class="border rounded-4 p-3 bg-body-tertiary h-100">
                      <div class="fw-bold">Som da Chamada</div>
                      <div class="text-body-secondary small mb-2">√Åudio tocado na TV quando o n√∫mero √© exibido (pasta <code>sounds/</code>).</div>
                      <div class="d-flex gap-2 align-items-center flex-wrap">
                        <select id="selectCallSound" class="form-select form-select-sm" style="flex: 1; min-width: 140px;">
                          <option value="notification-1.mp3">notification-1.mp3</option>
                        </select>
                        <button type="button" id="btnTestCallSound" class="btn btn-sm btn-outline-primary">Testar</button>
                      </div>
                      <div class="alert alert-soft small mb-0 mt-3">
                        O padr√£o √© <b>notification-1.mp3</b>. Clique em Testar para ouvir.
                      </div>
                    </div>
                  </div>
                  <!-- Card: √Åudio do v√≠deo -->
                  <div class="col-12 col-md-4">
                    <div class="border rounded-4 p-3 bg-body-tertiary h-100">
                      <div class="fw-bold">√Åudio do V√≠deo</div>
                      <div class="text-body-secondary small mb-2">Controle remoto do som do YouTube na TV.</div>
                      <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="btnVideoAudioToggle" class="btn-action btn-toggle-on tv-toggle-btn" style="min-width: 90px;">Ativado</button>
                      </div>
                      <div class="alert alert-soft small mb-0 mt-3">
                        Se necess√°rio, use o bot√£o "Ativar √Åudio" na TV.
                      </div>
                    </div>
                  </div>
                  <!-- Card: Reprodu√ß√£o do v√≠deo -->
                  <div class="col-12 col-md-4">
                    <div class="border rounded-4 p-3 bg-body-tertiary h-100">
                      <div class="fw-bold">Reprodu√ß√£o do V√≠deo</div>
                      <div class="text-body-secondary small mb-2">Pausar ou reproduzir o v√≠deo na TV.</div>
                      <div class="d-flex gap-2 justify-content-end">
                        <button type="button" id="btnVideoPlaybackToggle" class="btn-action btn-toggle-on tv-toggle-btn" style="min-width: 90px;">Reproduzir</button>
                      </div>
                      <div class="alert alert-soft small mb-0 mt-3">
                        Use <b>Pausar</b> durante comunicados importantes.
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Card: An√∫ncio de Voz (TTS) -->
                <div class="row g-4">
                <div class="col-12 col-lg-6">
                  <div class="border rounded-4 p-3 bg-body-tertiary">
                    <div class="d-flex align-items-center justify-content-between gap-2 flex-wrap mb-2">
                      <div>
                        <div class="fw-bold">An√∫ncio de Voz (TTS)</div>
                        <div class="text-body-secondary small">Anuncia a senha em voz sintetizada ap√≥s a campainha.</div>
                      </div>
                      <div class="d-flex gap-2">
                        <button type="button" id="btnTtsToggle" class="btn-action btn-toggle-on tv-toggle-btn" style="min-width: 110px;">Ativado</button>
                      </div>
                    </div>
                    <div class="d-flex gap-2 align-items-center flex-wrap mb-3">
                      <select id="selectTtsVoice" class="form-select form-select-sm" style="flex: 1; min-width: 140px;">
                        <option value="pf_dora">Dora (Feminina)</option>
                        <option value="pm_alex">Alex (Masculino)</option>
                        <option value="pm_santa">Santa (Masculino)</option>
                      </select>
                      <button type="button" id="btnTestTtsVoice" class="btn btn-sm btn-outline-primary">Testar</button>
                    </div>
                    <div class="mb-2">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="sliderTtsSpeed" class="form-label small mb-0">Velocidade</label>
                        <span id="labelTtsSpeed" class="text-body-secondary small">0.85√ó</span>
                      </div>
                      <input type="range" class="form-range" id="sliderTtsSpeed"
                        min="0.25" max="2.0" step="0.05" value="0.85">
                    </div>
                    <div class="mb-3">
                      <div class="d-flex justify-content-between align-items-center mb-1">
                        <label for="sliderTtsVolume" class="form-label small mb-0">Volume</label>
                        <span id="labelTtsVolume" class="text-body-secondary small">1.0√ó</span>
                      </div>
                      <input type="range" class="form-range" id="sliderTtsVolume"
                        min="0.5" max="2.0" step="0.1" value="1.0">
                    </div>
                    <div class="alert alert-soft small mb-0">
                      Clique em Testar para ouvir: "Senha A zero zero um, Caixas de Pagamento."
                    </div>
                  </div>
                </div>
                <!-- Card: Logo do Tenant (Branding) -->
                <div class="col-12 col-lg-6">
                  <div class="border rounded-4 p-3 bg-body-tertiary h-100">
                    <div class="fw-bold">Logo do Tenant</div>
                    <div class="text-body-secondary small mb-2">PNG/JPG/SVG. A TV carrega no pr√≥ximo refresh.</div>
                    <div class="mb-2">
                      <input id="logoFile" type="file" accept=".png,.jpg,.jpeg,.svg,image/png,image/jpeg,image/svg+xml" class="form-control form-control-sm scart-input" />
                    </div>
                    <div class="d-flex gap-2 mb-3">
                      <button id="btnUploadLogo" class="btn btn-sm btn-scart-primary flex-fill">Salvar logo</button>
                      <button id="btnClearLogo" class="btn btn-sm btn-scart-secondary flex-fill">Remover</button>
                    </div>
                    <div class="small text-body-secondary mb-1">Preview</div>
                    <div class="preview-box border rounded p-2 bg-dark bg-opacity-25" style="min-height: 60px;">
                      <img id="logoPreview" alt="logo preview" style="max-height: 70px; max-width: 100%; display: none" />
                      <div id="logoPreviewEmpty" class="text-body-secondary small">Sem logo.</div>
                    </div>
                    <div class="alert alert-soft small mb-0 mt-2">SVG/PNG com fundo transparente.</div>
                  </div>
                </div>
                </div>

              </div>
            </div>
          </div>

          <!-- Se√ß√£o: Playlist de V√≠deos (YouTube) -->
          <div class="card scart-card mb-4">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Playlist de V√≠deos</div>
                  <div class="small opacity-75 mt-1">Gerencie os v√≠deos exibidos na TV (ordem por posi√ß√£o).</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshYouTube" class="btn-action btn-refresh">Atualizar</button>
                  <button id="btnOpenYouTubeModal" class="btn-action btn-new">Novo Item</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="alert alert-soft small mb-3">
                Dica: a TV toca apenas v√≠deos <b>ativos</b>, na ordem de <b>posi√ß√£o</b> (1,2,3...). Empates usam a data de cadastro.
              </div>
              <!-- Filtros de m√≠dia -->
              <div class="d-flex gap-2 mb-3 align-items-center flex-wrap">
                <span class="small text-body-secondary me-2">Filtrar:</span>
                <button id="btnFilterAll" class="btn-action btn-filter-active" type="button">
                  Todos
                </button>
                <button id="btnFilterVideos" class="btn-action" type="button">
                  V√≠deos
                </button>
                <button id="btnFilterSlides" class="btn-action" type="button">
                  Imagens
                </button>
              </div>
              <div class="scart-table">
                <div class="table-responsive">
                  <table class="table table-sm align-middle" id="youtubeTable"></table>
                </div>
              </div>
            </div>
          </div>

          <!-- Se√ß√£o: Avisos do Rodap√© -->
          <div class="card scart-card">
            <div class="card-header-gradient">
              <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
                <div>
                  <div class="scart-section-title text-white">Avisos do Rodap√©</div>
                  <div class="small opacity-75 mt-1">Textos exibidos na TV em sequ√™ncia.</div>
                </div>
                <div class="d-flex gap-2">
                  <button id="btnRefreshAnnouncements" class="btn-action btn-refresh">Atualizar</button>
                  <button id="btnOpenAnnouncementModal" class="btn-action btn-new">Novo Aviso</button>
                </div>
              </div>
            </div>
            <div class="card-body p-4">
              <div class="alert alert-soft small mb-3">
                Dica: use mensagens curtas e objetivas. A posi√ß√£o define a ordem de exibi√ß√£o (1, 2, 3...).
              </div>
              <div class="scart-table">
                <div class="table-responsive">
                  <table class="table table-sm align-middle" id="announcementsTable"></table>
                </div>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
    </div><!-- /.main-content -->

    <!-- Footer Innersoft -->
    <footer class="footer-innersoft">
      <div class="container-fluid px-4">
        <div class="d-flex flex-column flex-md-row align-items-center justify-content-between gap-2">
          <div class="d-flex align-items-center gap-2">
             <img src="images/innersof_logo.png" alt="Innersoft" class="footer-logo" />
            <span class="footer-divider d-none d-md-block"></span>
            <span>Desenvolvido por <a href="https://innersoft.com.br" target="_blank" rel="noopener">Innersoft Tecnologia Ltda</a></span>
          </div>
          <div class="text-center text-md-end opacity-75">
            &copy; 2025 Innersoft Tecnologia Ltda. Todos os direitos reservados.
          </div>
        </div>
      </div>
    </footer>

    <!-- √Årea oculta para compatibilidade (panels flag) -->
    <div id="panels" class="d-none"></div>
    <div id="loggedHint" class="d-none"></div>

    <!-- YouTube Modal (SCart-style) -->
    <div class="modal fade" id="youtubeModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div id="ytModalTitle" class="fw-bold" style="font-size:1.15rem;">Novo v√≠deo</div>
              <div class="small opacity-75">URL do YouTube + coment√°rio + posi√ß√£o + ativo/inativo.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold">Tipo de M√≠dia</label>
                <select id="ytMediaType" class="form-select scart-input">
                  <option value="youtube">V√≠deo do YouTube</option>
                  <option value="slide">Slide/Imagem</option>
                </select>
              </div>
              <!-- YouTube fields -->
              <div id="ytYouTubeFields" class="col-12">
                <div class="col-12">
                  <label class="form-label fw-semibold">URL do YouTube</label>
                  <input id="ytUrl" class="form-control scart-input" placeholder="https://www.youtube.com/watch?v=..." />
                </div>
                <div class="col-12 mt-3">
                  <div class="alert alert-soft small mb-0">
                    Ao salvar, o sistema tenta buscar automaticamente o <b>t√≠tulo</b> e a <b>thumbnail</b> (oEmbed).
                  </div>
                </div>
              </div>
              <!-- Slide fields -->
              <div id="ytSlideFields" class="col-12" style="display: none;">
                <div class="col-12">
                  <label class="form-label fw-semibold">T√≠tulo do Slide</label>
                  <input id="ytSlideTitle" class="form-control scart-input" placeholder="Ex.: Slide institucional" />
                </div>
                <div class="col-12 mt-3">
                  <label class="form-label fw-semibold">Imagem do Slide <span class="text-danger">*</span></label>
                  <input id="ytSlideFile" type="file" accept="image/*" class="form-control scart-input" required />
                  <div class="form-text small">Fa√ßa upload de uma imagem (JPG, PNG, etc.).</div>
                </div>
                <div class="col-12 mt-3">
                  <label class="form-label fw-semibold">Dura√ß√£o (segundos)</label>
                  <input id="ytSlideDuration" type="number" min="1" class="form-control scart-input" value="10" />
                  <div class="form-text small">Tempo que o slide ficar√° exibido na TV.</div>
                </div>
                <div id="ytSlidePreview" class="col-12 mt-3" style="display: none;">
                  <label class="form-label fw-semibold">Preview</label>
                  <img id="ytSlidePreviewImg" src="" alt="Preview" class="img-fluid rounded border" style="max-height: 200px;" />
                </div>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Coment√°rio (opcional)</label>
                <input id="ytDesc" class="form-control scart-input" placeholder="Ex.: V√≠deo institucional / Campanha do m√™s" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Posi√ß√£o</label>
                <input id="ytPos" type="number" min="1" class="form-control scart-input" value="1" />
              </div>
              <div class="col-12 col-md-8 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="ytEnabled" checked>
                  <label class="form-check-label" for="ytEnabled">Ativo (tocar na TV)</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer p-4 pt-0 border-0 d-flex justify-content-between">
            <div class="small text-body-secondary">Ordena√ß√£o: posi√ß√£o ‚Üë, depois data de cadastro.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn-scart-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button id="btnSaveYouTube" type="button" class="btn-scart-primary">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Announcement Modal (SCart-style) -->
    <div class="modal fade" id="announcementModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Novo aviso do rodap√©</div>
              <div class="small opacity-75">Ser√° exibido na TV conforme a posi√ß√£o.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3">
              <div class="col-12">
                <label class="form-label fw-semibold">Mensagem</label>
                <textarea id="annMessage" class="form-control scart-input" rows="3" placeholder="Ex.: Bem-vindo(a)! Atendimento por ordem de chegada."></textarea>
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label fw-semibold">Posi√ß√£o</label>
                <input id="annPos" type="number" min="1" class="form-control scart-input" value="1" />
              </div>
              <div class="col-12 col-md-8 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="annEnabled" checked>
                  <label class="form-check-label" for="annEnabled">Ativo (exibir na TV)</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer p-4 pt-0 border-0 d-flex justify-content-between">
            <div class="small text-body-secondary">A ordem √© crescente por posi√ß√£o.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn-scart-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button id="btnSaveAnnouncement" type="button" class="btn-scart-primary">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Ranking de atendentes -->
    <div class="modal fade" id="rankingModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Ranking de atendentes</div>
              <div class="small opacity-75 mt-1">Atendimentos conclu√≠dos por per√≠odo.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="d-flex gap-2 mb-3">
              <select id="rankingPeriod" class="form-select form-select-sm" style="max-width: 140px;">
                <option value="today">Hoje</option>
                <option value="7d" selected>√öltimos 7 dias</option>
                <option value="30d">√öltimos 30 dias</option>
              </select>
              <button type="button" id="btnApplyRanking" class="btn btn-sm btn-scart-primary">Aplicar</button>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>#</th><th>Atendente</th><th>Atendimentos</th></tr></thead>
                <tbody id="rankingModalBody"></tbody>
              </table>
            </div>
            <div id="rankingModalEmpty" class="text-body-secondary small text-center py-4 d-none">Nenhum dado no per√≠odo.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Hist√≥rico de atendimentos (com filtros) -->
    <div class="modal fade" id="historyModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Hist√≥rico de atendimentos</div>
              <div class="small opacity-75 mt-1">Lista com filtros por data e atendente.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3 mb-3">
              <div class="col-12 col-md-3">
                <label class="form-label small">De (data)</label>
                <input type="date" id="historyFrom" class="form-control form-control-sm" />
              </div>
              <div class="col-12 col-md-3">
                <label class="form-label small">At√© (data)</label>
                <input type="date" id="historyTo" class="form-control form-control-sm" />
              </div>
              <div class="col-12 col-md-4">
                <label class="form-label small">Atendente</label>
                <select id="historyOperator" class="form-select form-select-sm">
                  <option value="">Todos</option>
                </select>
              </div>
              <div class="col-12 col-md-2 d-flex align-items-end">
                <button type="button" id="btnApplyHistory" class="btn btn-sm btn-scart-primary w-100">Filtrar</button>
              </div>
            </div>
            <div class="table-responsive">
              <table class="table table-sm align-middle">
                <thead><tr><th>Senha</th><th>Servi√ßo</th><th>Prioridade</th><th>Atendente</th><th>Guich√™</th><th class="text-nowrap">Chamado</th><th class="text-nowrap">Finalizado</th></tr></thead>
                <tbody id="historyModalBody"></tbody>
              </table>
            </div>
            <div id="historyModalEmpty" class="text-body-secondary small text-center py-4 d-none">Nenhum registro com os filtros informados.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Monitor ao Vivo -->
    <div class="modal fade" id="liveMonitorModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Monitor ao Vivo</div>
              <div class="small opacity-75 mt-1">Atualiza√ß√£o autom√°tica a cada 10 segundos. <span id="liveMonitorUpdatedAt"></span></div>
            </div>
            <div class="d-flex gap-2 align-items-center">
              <button type="button" id="btnRefreshLiveMonitor" class="btn btn-sm btn-outline-light">Atualizar</button>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
          </div>
          <div class="modal-body p-4">
            <!-- Linha 1: Fila atual -->
            <div class="small fw-semibold text-body-secondary mb-2 text-uppercase">Fila atual</div>
            <div class="row g-3 mb-4">
              <div class="col-6 col-md-4">
                <div class="metric-card metric-accent-orange text-center">
                  <div class="small opacity-75">Preferencial aguardando</div>
                  <div id="lmQueuePref" class="fw-bold" style="font-size:2rem;">‚Äî</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="metric-card metric-accent-blue text-center">
                  <div class="small opacity-75">Normal aguardando</div>
                  <div id="lmQueueNorm" class="fw-bold" style="font-size:2rem;">‚Äî</div>
                </div>
              </div>
              <div class="col-6 col-md-4">
                <div class="metric-card metric-accent-green text-center">
                  <div class="small opacity-75">Em atendimento</div>
                  <div id="lmInService" class="fw-bold" style="font-size:2rem;">‚Äî</div>
                </div>
              </div>
            </div>
            <!-- Linha 2: Hoje -->
            <div class="small fw-semibold text-body-secondary mb-2 text-uppercase">Hoje</div>
            <div class="row g-3 mb-4">
              <div class="col-6 col-md-3">
                <div class="metric-card metric-accent-green text-center">
                  <div class="small opacity-75">Atendidos</div>
                  <div id="lmAttended" class="fw-bold" style="font-size:2rem;">‚Äî</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="metric-card metric-accent-red text-center">
                  <div class="small opacity-75">Desistentes</div>
                  <div id="lmDesistentes" class="fw-bold" style="font-size:2rem;">‚Äî</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="metric-card metric-accent-blue text-center">
                  <div class="small opacity-75">Espera m√©dia</div>
                  <div id="lmAvgWait" class="fw-bold" style="font-size:1.5rem;">‚Äî</div>
                </div>
              </div>
              <div class="col-6 col-md-3">
                <div class="metric-card metric-accent-blue text-center">
                  <div class="small opacity-75">Atend. m√©dio</div>
                  <div id="lmAvgService" class="fw-bold" style="font-size:1.5rem;">‚Äî</div>
                </div>
              </div>
            </div>
            <!-- Linha 3: Gr√°fico por hora -->
            <div class="small fw-semibold text-body-secondary mb-2 text-uppercase">Atendimentos por hora (hoje)</div>
            <div id="lmHourlyChart" class="dash-chart-bars" style="min-height:80px;"></div>
            <div id="lmHourlyEmpty" class="text-body-secondary small text-center py-3 d-none">Nenhum atendimento registrado hoje.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- User Modal (SCart-style) - Novo / Editar operador -->
    <div class="modal fade" id="userModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div id="userModalTitle" class="fw-bold" style="font-size:1.15rem;">Novo operador</div>
              <div id="userModalSubtitle" class="small opacity-75">Crie um usu√°rio para realizar chamadas.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div id="userModalAlert" class="alert alert-warning small">
              Antes de confirmar: defina uma senha forte e mantenha o email correto para login.
            </div>
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Email</label>
                <input id="uEmail" class="form-control scart-input" placeholder="operador@empresa.com.br" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Nome</label>
                <input id="uName" class="form-control scart-input" placeholder="Nome do operador" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Tipo</label>
                <select id="uRole" class="form-select scart-input">
                  <option value="operator">Operador</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Senha</label>
                <input id="uPass" type="password" class="form-control scart-input" placeholder="m√≠n. 6 caracteres" />
              </div>
              <div class="col-12 col-md-6 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="uActive" checked>
                  <label class="form-check-label" for="uActive">Ativo</label>
                </div>
              </div>
              <div class="col-12">
                <label class="form-label fw-semibold">Servi√ßos que atende</label>
                <div id="uServicesCheckboxes" class="d-flex flex-wrap gap-2 pt-1">
                  <span class="text-body-secondary small">Carregando servi√ßos...</span>
                </div>
                <div class="form-text text-body-secondary">Sem sele√ß√£o: atende todos os servi√ßos.</div>
              </div>
            </div>
          </div>
          <div class="modal-footer p-4 pt-0 border-0 d-flex justify-content-between">
            <div id="userModalHint" class="small text-body-secondary">Tipo define permiss√µes: operador s√≥ chama senhas; admin acessa este painel.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn-scart-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button id="btnSaveUser" type="button" class="btn-scart-primary">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Counter Modal (SCart-style) -->
    <div class="modal fade" id="counterModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Novo guich√™</div>
              <div class="small opacity-75">Cadastre um ponto de atendimento.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3">
              <div class="col-12 col-md-8">
                <label class="form-label fw-semibold">Nome</label>
                <input id="cName" class="form-control scart-input" placeholder="Ex.: Guich√™ 04" />
              </div>
              <div class="col-12 col-md-4 d-flex align-items-end">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="cActive" checked>
                  <label class="form-check-label" for="cActive">Ativo</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer p-4 pt-0 border-0 d-flex justify-content-between">
            <div class="small text-body-secondary">Use nomes curtos e padronizados.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn-scart-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button id="btnSaveCounter" type="button" class="btn-scart-primary">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Service Modal (SCart-style) -->
    <div class="modal fade" id="serviceModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content modal-padrao-content">
          <div class="modal-header modal-padrao-header">
            <div>
              <div class="fw-bold" style="font-size:1.15rem;">Novo servi√ßo</div>
              <div class="small opacity-75">Cadastre o tipo de atendimento.</div>
            </div>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body p-4">
            <div class="row g-3">
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Nome</label>
                <input id="sName" class="form-control scart-input" placeholder="Ex.: Cr√©dito/Cobran√ßa" />
              </div>
              <div class="col-12 col-md-6">
                <label class="form-label fw-semibold">Prioridade</label>
                <select id="sPriority" class="form-select scart-input">
                  <option value="normal">Normal</option>
                  <option value="preferential">Preferencial</option>
                </select>
              </div>
              <div class="col-12">
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" id="sActive" checked>
                  <label class="form-check-label" for="sActive">Ativo</label>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer p-4 pt-0 border-0 d-flex justify-content-between">
            <div class="small text-body-secondary">Preferencial pode ser usado para filas priorit√°rias.</div>
            <div class="d-flex gap-2">
              <button type="button" class="btn-scart-secondary" data-bs-dismiss="modal">Cancelar</button>
              <button id="btnSaveService" type="button" class="btn-scart-primary">Salvar</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const EDGE_BASE = (window.EDGE_BASE || `${window.location.protocol}//${window.location.hostname}:7071`).replace(/\/$/, "");
      document.getElementById("edgeBase").textContent = EDGE_BASE;

      function setStatus(msg) {
        document.getElementById("loginStatus").textContent = msg || "";
      }

      function escapeHtml(str) {
        return String(str ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      // SweetAlert2 helpers
      function swalOk(title, text) {
        return Swal.fire({ icon: "success", title, text, timer: 1400, showConfirmButton: false });
      }
      function swalErr(title, text) {
        return Swal.fire({ icon: "error", title, text, confirmButtonText: "OK" });
      }
      function swalConfirm(title, text) {
        return Swal.fire({ icon: "warning", title, text, showCancelButton: true, confirmButtonText: "Confirmar", cancelButtonText: "Cancelar" });
      }

      // Visible diagnostics (so "nothing happens" is never silent)
      setStatus("Tenant validado. Pronto para login.");
      window.addEventListener("error", (e) => {
        setStatus(`Erro JS: ${e.message || e.type}`);
      });
      window.addEventListener("unhandledrejection", (e) => {
        setStatus(`Promise rejeitada: ${e.reason?.message || e.reason || "erro"}`);
      });
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
      function getToken() {
        return localStorage.getItem("tenant_token") || "";
      }

      function setToken(token) {
        if (token) localStorage.setItem("tenant_token", token);
        else localStorage.removeItem("tenant_token");
      }

      function authHeaders() {
        const t = getToken();
        return { Authorization: `Bearer ${t}`, "Content-Type": "application/json" };
      }

      async function api(path, opts = {}) {
        const res = await fetch(`${EDGE_BASE}${path}`, opts);
        const txt = await res.text();
        let data;
        try { data = JSON.parse(txt); } catch { data = txt; }
        if (!res.ok) throw new Error(`${res.status}: ${typeof data === "string" ? data : JSON.stringify(data)}`);
        return data;
      }

      async function refreshTenant() {
        const me = await api("/auth/me", { headers: authHeaders() });
        document.getElementById("tenantCnpj").textContent = me.tenant_cpf_cnpj || "-";
      }

      function setText(id, v) {
        const el = document.getElementById(id);
        if (!el) return;
        el.textContent = v ?? "-";
      }

      function fmtShortDt(s) {
        if (!s) return "-";
        try {
          const d = new Date(s);
          return d.toLocaleString("pt-BR", { dateStyle: "short", timeStyle: "short" });
        } catch {
          return String(s);
        }
      }
      function fmtDuration(seconds) {
        if (seconds == null || seconds <= 0) return "‚Äî";
        const sec = Math.round(Number(seconds));
        if (sec < 60) return sec + " s";
        const min = Math.floor(sec / 60);
        const rest = sec % 60;
        if (min < 60) return rest > 0 ? min + " min " + rest + " s" : min + " min";
        const h = Math.floor(min / 60);
        const m = min % 60;
        return m > 0 ? h + " h " + m + " min" : h + " h";
      }

      let dashAnalyticsPeriod = "7d";
      async function refreshDashboard() {
        const d = await api("/tenant/dashboard", { headers: authHeaders() });
        const t = d.tenant || {};
        const name = (t.nome_fantasia || t.nome_razao_social || "").trim();
        setText("tenantName", name || "-");
        setText("tenantCnpjFull", t.cpf_cnpj || "-");
        setText("tenantStatus", t.situacao || "-");

        setText("dashCounters", String(d.counters_total ?? "-"));
        setText("dashServices", String(d.services_total ?? "-"));
        setText("dashOperators", String(d.operators_total ?? "-"));
        setText("dashInService", String(d.in_service_last_60m ?? "-"));
        setText("dashAttendedToday", String(d.tickets_attended_today ?? "-"));
        setText("dashLastCall", fmtShortDt(d.last_called_at));

        // Carregar cada bloco independentemente para n√£o deixar tudo em branco se uma API falhar
        try {
          const analytics = await api(`/tenant/dashboard/analytics?period=${dashAnalyticsPeriod}`, { headers: authHeaders() }).catch(e => { console.warn("Dashboard analytics:", e); return { labels: [], values: [] }; });
          renderDashboardChart(analytics || { labels: [], values: [] });
        } catch (e) {
          console.warn("Dashboard analytics:", e);
          renderDashboardChart({ labels: [], values: [] });
        }
        try {
          const topOps = await api("/tenant/dashboard/top-operators?period=7d&limit=5", { headers: authHeaders() }).catch(e => { console.warn("Dashboard top-operators:", e); return []; });
          renderDashboardTopOperators(Array.isArray(topOps) ? topOps : []);
        } catch (e) {
          console.warn("Dashboard top-operators:", e);
          renderDashboardTopOperators([]);
        }
        try {
          const history = await api("/tenant/dashboard/history?limit=10", { headers: authHeaders() }).catch(e => { console.warn("Dashboard history:", e); return []; });
          renderDashboardRecent(Array.isArray(history) ? history : []);
        } catch (e) {
          console.warn("Dashboard history:", e);
          renderDashboardRecent([]);
        }
        try {
          const kpis = await api(`/tenant/dashboard/kpis?period=${dashAnalyticsPeriod}`, { headers: authHeaders() }).catch(e => { console.warn("Dashboard KPIs:", e); return null; });
          renderDashboardKpis(kpis);
        } catch (e) {
          console.warn("Dashboard KPIs:", e);
          renderDashboardKpis(null);
        }
      }
      function renderDashboardKpis(data) {
        const pref = data ? (data.preferential_count ?? 0) : 0;
        const norm = data ? (data.normal_count ?? 0) : 0;
        const total = pref + norm || 1;
        setText("dashKpiPref", String(pref));
        setText("dashKpiNorm", String(norm));
        const prefBar = document.getElementById("dashKpiPrefBar");
        const normBar = document.getElementById("dashKpiNormBar");
        if (prefBar) prefBar.style.flex = "0 0 " + (total ? (pref / total * 100) : 50) + "%";
        if (normBar) normBar.style.flex = "0 0 " + (total ? (norm / total * 100) : 50) + "%";
        setText("dashKpiMaxTime", data ? fmtDuration(data.max_duration_seconds) : "‚Äî");
        setText("dashKpiMinTime", data ? fmtDuration(data.min_duration_seconds) : "‚Äî");
        const topName = data ? (data.top_operator_name || "‚Äî") : "‚Äî";
        setText("dashKpiTopOpName", topName);
        const topEl = document.getElementById("dashKpiTopOpName");
        if (topEl) topEl.title = topName;
        setText("dashKpiTopOpCount", String(data ? (data.top_operator_count ?? 0) : 0));
        setText("dashKpiMaiorQtdName", topName);
        setText("dashKpiMaiorQtdCount", String(data ? (data.top_operator_count ?? 0) : 0));
        const fastName = data ? (data.fastest_operator_name || "‚Äî") : "‚Äî";
        setText("dashKpiFastOpName", fastName);
        const fastEl = document.getElementById("dashKpiFastOpName");
        if (fastEl) fastEl.title = fastName;
        setText("dashKpiFastOpAvg", data ? fmtDuration(data.fastest_operator_avg_seconds) : "‚Äî");
      }
      function renderDashboardChart(data) {
        const container = document.getElementById("dashChartBars");
        const empty = document.getElementById("dashChartEmpty");
        if (!container) return;
        const labels = data.labels || [];
        const values = data.values || [];
        const maxVal = Math.max(1, ...values);
        if (labels.length === 0) {
          container.innerHTML = "";
          if (empty) empty.classList.remove("d-none");
          return;
        }
        if (empty) empty.classList.add("d-none");
        container.innerHTML = labels.map((label, i) => {
          const v = values[i] || 0;
          const pct = maxVal ? Math.round((v / maxVal) * 100) : 0;
          return `<div class="dash-chart-bar-wrap"><div class="dash-chart-bar" style="height: ${Math.max(4, pct)}%"></div><span class="small">${escapeHtml(label)}</span></div>`;
        }).join("");
      }
      function renderDashboardTopOperators(list) {
        const el = document.getElementById("dashTopOperatorsList");
        if (!el) return;
        if (!Array.isArray(list) || list.length === 0) {
          el.innerHTML = '<p class="text-body-secondary small mb-0">Nenhum dado no per√≠odo.</p>';
          return;
        }
        el.innerHTML = list.map((op, i) => `
          <div class="dash-top-op-row">
            <span class="dash-top-op-rank">${i + 1}¬∫</span>
            <span class="dash-top-op-name" title="${escapeHtml(op.operator_name)}">${escapeHtml(op.operator_name)}</span>
            <span class="dash-top-op-count">${op.completed_count}</span>
          </div>
        `).join("");
      }
      function renderDashboardRecent(list) {
        const tbody = document.getElementById("dashRecentBody");
        const empty = document.getElementById("dashRecentEmpty");
        if (!tbody) return;
        if (!Array.isArray(list) || list.length === 0) {
          tbody.innerHTML = "";
          if (empty) empty.classList.remove("d-none");
          return;
        }
        if (empty) empty.classList.add("d-none");
        tbody.innerHTML = list.map(h => `
          <tr>
            <td class="fw-semibold">${escapeHtml(h.ticket_code || "‚Äî")}</td>
            <td>${escapeHtml(h.service_name || "‚Äî")}</td>
            <td>${escapeHtml(h.operator_name || "‚Äî")}</td>
            <td>${escapeHtml(h.counter_name || "‚Äî")}</td>
            <td class="text-nowrap">${escapeHtml(fmtDt(h.completed_at))}</td>
          </tr>
        `).join("");
      }

      async function refreshBrandingPreview() {
        try {
          const t = await api("/tenant/me", { headers: authHeaders() });
          const img = document.getElementById("logoPreview");
          const empty = document.getElementById("logoPreviewEmpty");
          const mini = document.getElementById("tenantLogoMini");
          if (t.logo_base64) {
            img.src = t.logo_base64;
            img.style.display = "block";
            empty.style.display = "none";
            if (mini) { mini.src = t.logo_base64; mini.style.display = "block"; }
          } else {
            img.src = "";
            img.style.display = "none";
            empty.style.display = "block";
            if (mini) { mini.src = ""; mini.style.display = "none"; }
          }
        } catch {}
      }

      let lastUsers = [];
      let lastServices = [];
      let editingUserId = null;
      async function refreshUsers() {
        const data = await api("/tenant/users", { headers: authHeaders() });
        lastUsers = Array.isArray(data) ? data : [];
        renderUsersTable(data);
      }
      async function refreshCounters() {
        const data = await api("/tenant/counters", { headers: authHeaders() });
        renderCountersTable(data);
      }
      async function refreshServices() {
        const data = await api("/tenant/services", { headers: authHeaders() });
        lastServices = Array.isArray(data) ? data : [];
        renderServicesTable(data);
      }

      function renderServiceCheckboxes(services, selectedIds) {
        const container = document.getElementById("uServicesCheckboxes");
        if (!container) return;
        const active = (services || []).filter(s => s.active);
        if (!active.length) {
          container.innerHTML = '<span class="text-body-secondary small">Nenhum servi√ßo cadastrado.</span>';
          return;
        }
        // Agrupar service_ids por nome √∫nico
        const groups = {};
        for (const s of active) {
          if (!groups[s.name]) groups[s.name] = [];
          groups[s.name].push(s.id);
        }
        const sel = new Set(selectedIds || []);
        container.innerHTML = Object.entries(groups).map(([name, ids]) => {
          const checked = ids.some(id => sel.has(id)) ? "checked" : "";
          const idsJson = escapeHtml(JSON.stringify(ids));
          return `<div class="form-check">
            <input class="form-check-input" type="checkbox" id="usvc_${escapeHtml(ids[0])}" data-svc-ids='${idsJson}' ${checked}>
            <label class="form-check-label" for="usvc_${escapeHtml(ids[0])}">${escapeHtml(name)}</label>
          </div>`;
        }).join("");
      }

      function collectCheckedServiceIds() {
        const ids = [];
        document.querySelectorAll("#uServicesCheckboxes input[type=checkbox]:checked").forEach(cb => {
          try { ids.push(...JSON.parse(cb.getAttribute("data-svc-ids") || "[]")); } catch {}
        });
        return ids;
      }

      async function refreshAnnouncements() {
        const data = await api("/tenant/announcements", { headers: authHeaders() });
        renderAnnouncementsTable(data);
      }

      // Estado do filtro de playlist (carregado do backend)
      let ytTableFilter = "all"; // "all", "videos", "slides"

      // Fun√ß√£o de filtro
      function filterYouTubeRows(rows, filterType) {
        if (!rows || !Array.isArray(rows)) return [];
        if (filterType === "all") return rows;
        if (filterType === "videos") return rows.filter(r => (r.media_type || "youtube").toLowerCase() !== "slide");
        if (filterType === "slides") return rows.filter(r => (r.media_type || "youtube").toLowerCase() === "slide");
        return rows;
      }

      // Atualizar estilo dos bot√µes de filtro
      function updateFilterButtons() {
        const btnAll = document.getElementById("btnFilterAll");
        const btnVideos = document.getElementById("btnFilterVideos");
        const btnSlides = document.getElementById("btnFilterSlides");
        
        if (btnAll && btnVideos && btnSlides) {
          // Remove classe ativa de todos
          btnAll.classList.remove("btn-filter-active");
          btnVideos.classList.remove("btn-filter-active");
          btnSlides.classList.remove("btn-filter-active");
          
          // Adiciona classe ativa no bot√£o selecionado
          if (ytTableFilter === "all") {
            btnAll.classList.add("btn-filter-active");
          } else if (ytTableFilter === "videos") {
            btnVideos.classList.add("btn-filter-active");
          } else if (ytTableFilter === "slides") {
            btnSlides.classList.add("btn-filter-active");
          }
        }
      }

      // Carregar prefer√™ncia do filtro do backend
      async function loadAdminSettings() {
        try {
          const settings = await api("/tenant/admin-settings", { headers: authHeaders() });
          ytTableFilter = settings.admin_playlist_filter || "all";
          updateFilterButtons();
        } catch (e) {
          console.warn("Failed to load admin settings:", e);
          ytTableFilter = "all"; // Default
          updateFilterButtons();
        }
      }

      // Salvar prefer√™ncia do filtro no backend
      async function saveAdminSettings() {
        try {
          await api("/tenant/admin-settings", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify({ admin_playlist_filter: ytTableFilter })
          });
        } catch (e) {
          console.error("Failed to save admin settings:", e);
        }
      }

      async function refreshYouTube() {
        const data = await api("/tenant/youtube", { headers: authHeaders() });
        renderYouTubeTable(data);
      }

      // TV Settings state
      let currentTVSettings = { tv_theme: "dark", tv_audio_enabled: true, tv_call_sound: "notification-1.mp3", tv_video_muted: true, tv_video_paused: false, tts_enabled: false, tts_voice: "pf_dora", tts_speed: 0.85, tts_volume: 1.0 };

      async function refreshTVSettings() {
        try {
          const [data, soundsRes] = await Promise.all([
            api("/tenant/tv-settings", { headers: authHeaders() }),
            api("/api/sounds"),
          ]);
          currentTVSettings = data;
          const sounds = (soundsRes && soundsRes.sounds) || ["notification-1.mp3"];
          const sel = document.getElementById("selectCallSound");
          if (sel) {
            sel.innerHTML = sounds.map((f) => `<option value="${escapeHtml(f)}">${escapeHtml(f)}</option>`).join("");
          }
          updateTVSettingsUI();
        } catch (e) {
          console.warn("Erro ao carregar configura√ß√µes TV:", e);
        }
      }

      function setSingleToggle(btn, isOn, labelOn, labelOff) {
        if (!btn) return;
        btn.textContent = isOn ? labelOn : labelOff;
        btn.classList.toggle("btn-toggle-on", isOn);
        btn.classList.toggle("btn-toggle-off", !isOn);
      }

      function updateTVSettingsUI() {
        // Tema (Dark / Light)
        setSingleToggle(
          document.getElementById("btnThemeToggle"),
          currentTVSettings.tv_theme === "dark",
          "Dark",
          "Light"
        );

        // √Åudio de chamada (Ativado / Desativado)
        setSingleToggle(
          document.getElementById("btnAudioToggle"),
          currentTVSettings.tv_audio_enabled,
          "Ativado",
          "Desativado"
        );

        // Som da chamada (dropdown)
        const sel = document.getElementById("selectCallSound");
        if (sel) {
          const v = currentTVSettings.tv_call_sound || "notification-1.mp3";
          if (Array.from(sel.options).some((o) => o.value === v)) sel.value = v;
          else sel.selectedIndex = 0;
        }

        // √Åudio do v√≠deo (Ativado / Mutado) ‚Äî muted=true significa som OFF
        setSingleToggle(
          document.getElementById("btnVideoAudioToggle"),
          !currentTVSettings.tv_video_muted,
          "Ativado",
          "Mutado"
        );

        // Reprodu√ß√£o do v√≠deo (Reproduzir / Pausar)
        setSingleToggle(
          document.getElementById("btnVideoPlaybackToggle"),
          !currentTVSettings.tv_video_paused,
          "Reproduzir",
          "Pausar"
        );

        // TTS (Ativado / Desativado)
        setSingleToggle(
          document.getElementById("btnTtsToggle"),
          currentTVSettings.tts_enabled,
          "Ativado",
          "Desativado"
        );
        const selVoice = document.getElementById("selectTtsVoice");
        if (selVoice) selVoice.value = currentTVSettings.tts_voice || "pf_dora";
        const sliderSpeed = document.getElementById("sliderTtsSpeed");
        const sliderVolume = document.getElementById("sliderTtsVolume");
        if (sliderSpeed) {
          sliderSpeed.value = currentTVSettings.tts_speed ?? 0.85;
          document.getElementById("labelTtsSpeed").textContent = `${Number(sliderSpeed.value).toFixed(2)}√ó`;
        }
        if (sliderVolume) {
          sliderVolume.value = currentTVSettings.tts_volume ?? 1.0;
          document.getElementById("labelTtsVolume").textContent = `${Number(sliderVolume.value).toFixed(1)}√ó`;
        }
      }

      async function saveTVSettings() {
        try {
          await api("/tenant/tv-settings", {
            method: "POST",
            headers: authHeaders(),
            body: JSON.stringify(currentTVSettings),
          });
          swalOk("Salvo", "Configura√ß√µes da TV atualizadas.");
        } catch (e) {
          swalErr("Erro", String(e));
        }
      }

      function tableClass() {
        return "table table-sm align-middle";
      }

      function fmtDt(s) {
        if (!s) return "";
        try { return new Date(s).toLocaleString("pt-BR"); } catch { return String(s); }
      }

      function renderUsersTable(rows) {
        const el = document.getElementById("usersTable");
        if (!el) return;
        const r = rows || [];
        el.className = tableClass();
        el.innerHTML = `
          <thead>
            <tr>
              <th>Email</th>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Status</th>
              <th class="text-nowrap">Criado em</th>
              <th style="width: 220px"></th>
            </tr>
          </thead>
          <tbody>
            ${r.map(u => `
              <tr>
                <td class="text-nowrap">${escapeHtml(u.email || "")}</td>
                <td>${escapeHtml(u.full_name || "")}</td>
                <td>${escapeHtml(u.role || "")}</td>
                <td>${u.active ? '<span class="badge text-bg-success">ativo</span>' : '<span class="badge text-bg-secondary">inativo</span>'}</td>
                <td class="text-nowrap">${escapeHtml(fmtDt(u.created_at))}</td>
                <td class="text-end d-flex gap-1 justify-content-end flex-nowrap" style="white-space:nowrap;">
                  <button class="btn-action btn-refresh" data-edit-user="${escapeHtml(u.id || "")}" title="Editar">Editar</button>
                  <button class="btn-action ${u.active ? 'btn-toggle-off' : 'btn-toggle-on'}" data-toggle-user="${escapeHtml(u.id || "")}" data-active="${u.active ? '1' : '0'}">${u.active ? 'Desativar' : 'Ativar'}</button>
                  <button class="btn-action btn-delete" data-del-user="${escapeHtml(u.id || "")}">Excluir</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        `;
      }

      function renderCountersTable(rows) {
        const el = document.getElementById("countersTable");
        if (!el) return;
        const r = rows || [];
        el.className = tableClass();
        el.innerHTML = `
          <thead>
            <tr>
              <th>Nome</th>
              <th>Status</th>
              <th class="text-nowrap">Criado em</th>
              <th style="width: 180px"></th>
            </tr>
          </thead>
          <tbody>
            ${r.map(c => `
              <tr>
                <td class="text-nowrap">${escapeHtml(c.name || "")}</td>
                <td>${c.active ? '<span class="badge text-bg-success">ativo</span>' : '<span class="badge text-bg-secondary">inativo</span>'}</td>
                <td class="text-nowrap">${escapeHtml(fmtDt(c.created_at))}</td>
                <td class="text-end d-flex gap-1 justify-content-end">
                  <button class="btn-action ${c.active ? 'btn-toggle-off' : 'btn-toggle-on'}" data-toggle-counter="${escapeHtml(c.id || "")}" data-active="${c.active ? '1' : '0'}">${c.active ? 'Desativar' : 'Ativar'}</button>
                  <button class="btn-action btn-delete" data-del-counter="${escapeHtml(c.id || "")}">Excluir</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        `;
      }

      function renderServicesTable(rows) {
        const el = document.getElementById("servicesTable");
        if (!el) return;
        const r = rows || [];
        el.className = tableClass();
        el.innerHTML = `
          <thead>
            <tr>
              <th>Nome</th>
              <th>Prioridade</th>
              <th>Status</th>
              <th class="text-nowrap">Criado em</th>
              <th style="width: 180px"></th>
            </tr>
          </thead>
          <tbody>
            ${r.map(s => `
              <tr>
                <td class="text-nowrap">${escapeHtml(s.name || "")}</td>
                <td>${escapeHtml(s.priority_mode || "")}</td>
                <td>${s.active ? '<span class="badge text-bg-success">ativo</span>' : '<span class="badge text-bg-secondary">inativo</span>'}</td>
                <td class="text-nowrap">${escapeHtml(fmtDt(s.created_at))}</td>
                <td class="text-end d-flex gap-1 justify-content-end">
                  <button class="btn-action ${s.active ? 'btn-toggle-off' : 'btn-toggle-on'}" data-toggle-service="${escapeHtml(s.id || "")}" data-active="${s.active ? '1' : '0'}">${s.active ? 'Desativar' : 'Ativar'}</button>
                  <button class="btn-action btn-delete" data-del-service="${escapeHtml(s.id || "")}">Excluir</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        `;
      }

      function renderAnnouncementsTable(rows) {
        const el = document.getElementById("announcementsTable");
        if (!el) return;
        const r = rows || [];
        el.className = tableClass();
        el.innerHTML = `
          <thead>
            <tr>
              <th style="width: 70px">Pos</th>
              <th>Mensagem</th>
              <th style="width: 110px">Status</th>
              <th style="width: 180px"></th>
            </tr>
          </thead>
          <tbody>
            ${r.map(a => `
              <tr>
                <td class="text-nowrap">${escapeHtml(String(a.position ?? ""))}</td>
                <td>${escapeHtml(a.message || "")}</td>
                <td>${a.enabled ? '<span class="badge text-bg-success">ativo</span>' : '<span class="badge text-bg-secondary">inativo</span>'}</td>
                <td class="text-end d-flex gap-1 justify-content-end">
                  <button class="btn-action ${a.enabled ? 'btn-toggle-off' : 'btn-toggle-on'}" data-toggle-ann="${escapeHtml(a.id || "")}" data-enabled="${a.enabled ? '1' : '0'}">${a.enabled ? 'Desativar' : 'Ativar'}</button>
                  <button class="btn-action btn-delete" data-del-ann="${escapeHtml(a.id || "")}">Excluir</button>
                </td>
              </tr>
            `).join("")}
          </tbody>
        `;
      }

      function renderYouTubeTable(rows) {
        const el = document.getElementById("youtubeTable");
        if (!el) return;
        // Aplicar filtro antes de renderizar
        const filtered = filterYouTubeRows(rows || [], ytTableFilter);
        const r = filtered;
        el.className = tableClass();
        el.innerHTML = `
          <thead>
            <tr>
              <th style="width: 70px">Pos</th>
              <th style="width: 80px">Thumb</th>
              <th>Tipo</th>
              <th>T√≠tulo</th>
              <th>Coment√°rio</th>
              <th class="text-nowrap">Criado em</th>
              <th style="width: 110px">Status</th>
              <th style="width: 260px"></th>
            </tr>
          </thead>
          <tbody>
            ${r.map(v => {
              const mediaType = (v.media_type || "youtube").toLowerCase();
              const isSlide = mediaType === "slide";
              // Para slides: usar image_url diretamente (redimensionado via CSS)
              // Para v√≠deos: usar thumbnail_url (do YouTube)
              const thumbUrl = isSlide 
                ? (v.image_url || "") 
                : (v.thumbnail_url || "");
              return `
              <tr>
                <td class="text-nowrap">${escapeHtml(String(v.position ?? ""))}</td>
                <td>
                  ${thumbUrl ? `<img src="${escapeHtml(thumbUrl.startsWith('/') ? `${window.location.protocol}//${window.location.hostname}:7071${thumbUrl}` : thumbUrl)}" alt="thumb" style="width:64px;height:36px;object-fit:cover;border-radius:8px;border:1px solid rgba(0,0,0,.08)" />` : `<span class="text-body-secondary small">‚Äî</span>`}
                </td>
                <td>
                  ${isSlide ? '<span class="badge text-bg-info">Slide</span>' : '<span class="badge text-bg-danger">YouTube</span>'}
                </td>
                <td>
                  <div class="fw-semibold">${escapeHtml(v.title || "(sem t√≠tulo)")}</div>
                  ${!isSlide ? `<div class="small text-body-secondary">${escapeHtml(v.author_name || "")}</div>` : ""}
                </td>
                <td>${escapeHtml(v.description || "")}</td>
                <td class="text-nowrap">${escapeHtml(fmtDt(v.created_at))}</td>
                <td>${v.enabled ? '<span class="badge text-bg-success">ativo</span>' : '<span class="badge text-bg-secondary">inativo</span>'}</td>
                <td class="text-end d-flex gap-1 justify-content-end flex-nowrap" style="white-space:nowrap;">
                  <button class="btn-action btn-refresh" data-edit-yt="${escapeHtml(v.id || "")}">Editar</button>
                  <button class="btn-action ${v.enabled ? 'btn-toggle-off' : 'btn-toggle-on'}" data-toggle-yt="${escapeHtml(v.id || "")}" data-enabled="${v.enabled ? '1' : '0'}">${v.enabled ? 'Desativar' : 'Ativar'}</button>
                  <button class="btn-action btn-delete" data-del-yt="${escapeHtml(v.id || "")}">Excluir</button>
                </td>
              </tr>
            `;
            }).join("")}
          </tbody>
        `;
      }

      async function afterLogin() {
        // hide modal if open
        try {
          const el = document.getElementById("loginModal");
          const inst = bootstrap.Modal.getInstance(el);
          if (inst) inst.hide();
        } catch {}

        // Carregar prefer√™ncias do admin (incluindo filtro de playlist)
        await loadAdminSettings();

        // Mostrar bot√µes de logout
        document.getElementById("btnLogout").classList.remove("d-none");
        document.getElementById("btnLogoutTop").classList.remove("d-none");

        // Mostrar √°rea de abas (container principal j√° vis√≠vel, apenas habilita intera√ß√£o)
        const tabsNav = document.getElementById("adminTabs");
        const tabsContent = document.getElementById("adminTabsContent");
        tabsNav.style.pointerEvents = "auto";
        tabsNav.style.opacity = "1";
        tabsContent.style.opacity = "1";
        tabsContent.style.pointerEvents = "auto";

        setStatus("Autenticado.");
        await refreshTenant();
        await Promise.all([refreshDashboard(), refreshUsers(), refreshCounters(), refreshServices(), refreshBrandingPreview(), refreshAnnouncements(), refreshTVSettings(), refreshYouTube()]);
      }

      document.getElementById("btnLogin").addEventListener("click", async () => {
        try {
          setStatus("Entrando...");
          const payload = {
            email: document.getElementById("email").value,
            password: document.getElementById("password").value,
          };
          const data = await api("/auth/login", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload) });
          setToken(data.access_token);
          await afterLogin();
          swalOk("Login OK", "Bem-vindo!");
        } catch (e) {
          setStatus(`Falha no login: ${String(e)}`);
          swalErr("Falha no login", String(e));
        }
      });

      document.getElementById("btnLogout").addEventListener("click", () => {
        setToken("");
        location.reload();
      });
      document.getElementById("btnLogoutTop").addEventListener("click", () => {
        setToken("");
        location.reload();
      });

      // Theme toggle (Bootstrap color mode)
      const themeBtn = document.getElementById("themeToggle");
      const themeBtnModal = document.getElementById("themeToggleInModal");
      function getTheme() { return localStorage.getItem("admin_theme") || "dark"; }
      function setTheme(v) { localStorage.setItem("admin_theme", v); document.documentElement.setAttribute("data-bs-theme", v); themeBtn.textContent = v === "dark" ? "Light" : "Dark"; }
      setTheme(getTheme());
      if (themeBtnModal) themeBtnModal.textContent = themeBtn.textContent;
      themeBtn.addEventListener("click", () => {
        setTheme(getTheme() === "dark" ? "light" : "dark");
        refreshUsers(); refreshCounters(); refreshServices(); refreshAnnouncements();
        if (themeBtnModal) themeBtnModal.textContent = themeBtn.textContent;
      });
      if (themeBtnModal) {
        themeBtnModal.addEventListener("click", () => {
          themeBtn.click();
        });
      }

      document.getElementById("btnRefreshUsers").addEventListener("click", refreshUsers);
      document.getElementById("btnRefreshCounters").addEventListener("click", refreshCounters);
      document.getElementById("btnRefreshDashboard")?.addEventListener("click", () => refreshDashboard().catch(() => {}));

      document.getElementById("dashPeriod7d")?.addEventListener("click", async () => {
        dashAnalyticsPeriod = "7d";
        document.querySelectorAll(".dash-period-btn").forEach(b => { b.classList.remove("active"); });
        document.getElementById("dashPeriod7d")?.classList.add("active");
        try {
          const [chartData, kpis] = await Promise.all([
            api(`/tenant/dashboard/analytics?period=7d`, { headers: authHeaders() }),
            api(`/tenant/dashboard/kpis?period=7d`, { headers: authHeaders() }).catch(() => null),
          ]);
          renderDashboardChart(chartData);
          renderDashboardKpis(kpis);
        } catch (e) { console.warn(e); }
      });
      document.getElementById("dashPeriod30d")?.addEventListener("click", async () => {
        dashAnalyticsPeriod = "30d";
        document.querySelectorAll(".dash-period-btn").forEach(b => { b.classList.remove("active"); });
        document.getElementById("dashPeriod30d")?.classList.add("active");
        try {
          const [chartData, kpis] = await Promise.all([
            api(`/tenant/dashboard/analytics?period=30d`, { headers: authHeaders() }),
            api(`/tenant/dashboard/kpis?period=30d`, { headers: authHeaders() }).catch(() => null),
          ]);
          renderDashboardChart(chartData);
          renderDashboardKpis(kpis);
        } catch (e) { console.warn(e); }
      });

      const rankingModal = new bootstrap.Modal(document.getElementById("rankingModal"));
      document.getElementById("btnOpenRankingModal")?.addEventListener("click", async () => {
        const period = document.getElementById("rankingPeriod")?.value || "7d";
        const list = await api(`/tenant/dashboard/top-operators?period=${period}&limit=20`, { headers: authHeaders() });
        const tbody = document.getElementById("rankingModalBody");
        const empty = document.getElementById("rankingModalEmpty");
        if (Array.isArray(list) && list.length > 0) {
          empty.classList.add("d-none");
          tbody.innerHTML = list.map((op, i) => `<tr><td class="fw-bold">${i + 1}¬∫</td><td>${escapeHtml(op.operator_name)}</td><td>${op.completed_count}</td></tr>`).join("");
        } else {
          tbody.innerHTML = "";
          empty.classList.remove("d-none");
        }
        rankingModal.show();
      });
      document.getElementById("btnApplyRanking")?.addEventListener("click", async () => {
        const period = document.getElementById("rankingPeriod")?.value || "7d";
        const list = await api(`/tenant/dashboard/top-operators?period=${period}&limit=20`, { headers: authHeaders() });
        const tbody = document.getElementById("rankingModalBody");
        const empty = document.getElementById("rankingModalEmpty");
        if (Array.isArray(list) && list.length > 0) {
          empty.classList.add("d-none");
          tbody.innerHTML = list.map((op, i) => `<tr><td class="fw-bold">${i + 1}¬∫</td><td>${escapeHtml(op.operator_name)}</td><td>${op.completed_count}</td></tr>`).join("");
        } else {
          tbody.innerHTML = "";
          empty.classList.remove("d-none");
        }
      });

      const historyModal = new bootstrap.Modal(document.getElementById("historyModal"));
      document.getElementById("btnOpenHistoryModal")?.addEventListener("click", async () => {
        const users = await api("/tenant/users", { headers: authHeaders() });
        const sel = document.getElementById("historyOperator");
        if (sel) {
          const opts = (users || []).filter(u => u.role === "operator" || u.role === "admin").map(u => `<option value="${escapeHtml(u.id || "")}">${escapeHtml(u.full_name || u.email || u.id || "‚Äî")}</option>`);
          sel.innerHTML = '<option value="">Todos</option>' + opts.join("");
        }
        const from = document.getElementById("historyFrom");
        const to = document.getElementById("historyTo");
        const toDate = new Date();
        const fromDate = new Date(toDate);
        fromDate.setDate(fromDate.getDate() - 7);
        if (from) from.value = fromDate.toISOString().slice(0, 10);
        if (to) to.value = toDate.toISOString().slice(0, 10);
        const fromVal = from?.value || "";
        const toVal = to?.value || "";
        const opId = document.getElementById("historyOperator")?.value || "";
        const params = new URLSearchParams({ limit: "100" });
        if (fromVal) params.set("from_date", fromVal);
        if (toVal) params.set("to_date", toVal);
        if (opId) params.set("operator_id", opId);
        const list = await api(`/tenant/dashboard/history?${params}`, { headers: authHeaders() });
        const tbody = document.getElementById("historyModalBody");
        const empty = document.getElementById("historyModalEmpty");
        if (Array.isArray(list) && list.length > 0) {
          empty.classList.add("d-none");
          tbody.innerHTML = list.map(h => `
            <tr>
              <td class="fw-semibold">${escapeHtml(h.ticket_code || "‚Äî")}</td>
              <td>${escapeHtml(h.service_name || "‚Äî")}</td>
              <td>${escapeHtml(h.priority || "‚Äî")}</td>
              <td>${escapeHtml(h.operator_name || "‚Äî")}</td>
              <td>${escapeHtml(h.counter_name || "‚Äî")}</td>
              <td class="text-nowrap small">${escapeHtml(fmtDt(h.called_at))}</td>
              <td class="text-nowrap small">${escapeHtml(fmtDt(h.completed_at))}</td>
            </tr>
          `).join("");
        } else {
          tbody.innerHTML = "";
          empty.classList.remove("d-none");
        }
        historyModal.show();
      });
      document.getElementById("btnApplyHistory")?.addEventListener("click", async () => {
        const fromVal = document.getElementById("historyFrom")?.value || "";
        const toVal = document.getElementById("historyTo")?.value || "";
        const opId = document.getElementById("historyOperator")?.value || "";
        const params = new URLSearchParams({ limit: "100" });
        if (fromVal) params.set("from_date", fromVal);
        if (toVal) params.set("to_date", toVal);
        if (opId) params.set("operator_id", opId);
        const list = await api(`/tenant/dashboard/history?${params}`, { headers: authHeaders() });
        const tbody = document.getElementById("historyModalBody");
        const empty = document.getElementById("historyModalEmpty");
        if (Array.isArray(list) && list.length > 0) {
          empty.classList.add("d-none");
          tbody.innerHTML = list.map(h => `
            <tr>
              <td class="fw-semibold">${escapeHtml(h.ticket_code || "‚Äî")}</td>
              <td>${escapeHtml(h.service_name || "‚Äî")}</td>
              <td>${escapeHtml(h.priority || "‚Äî")}</td>
              <td>${escapeHtml(h.operator_name || "‚Äî")}</td>
              <td>${escapeHtml(h.counter_name || "‚Äî")}</td>
              <td class="text-nowrap small">${escapeHtml(fmtDt(h.called_at))}</td>
              <td class="text-nowrap small">${escapeHtml(fmtDt(h.completed_at))}</td>
            </tr>
          `).join("");
        } else {
          tbody.innerHTML = "";
          empty.classList.remove("d-none");
        }
      });
      document.getElementById("btnRefreshServices").addEventListener("click", refreshServices);
      document.getElementById("btnRefreshAnnouncements").addEventListener("click", refreshAnnouncements);
      document.getElementById("btnRefreshYouTube").addEventListener("click", refreshYouTube);

      // Event listeners para bot√µes de filtro de playlist
      document.getElementById("btnFilterAll")?.addEventListener("click", async () => {
        ytTableFilter = "all";
        updateFilterButtons();
        await saveAdminSettings();
        refreshYouTube();
      });

      document.getElementById("btnFilterVideos")?.addEventListener("click", async () => {
        ytTableFilter = "videos";
        updateFilterButtons();
        await saveAdminSettings();
        refreshYouTube();
      });

      document.getElementById("btnFilterSlides")?.addEventListener("click", async () => {
        ytTableFilter = "slides";
        updateFilterButtons();
        await saveAdminSettings();
        refreshYouTube();
      });

      // Users/Counters/Services modals (SCart-style)
      const userModal = new bootstrap.Modal(document.getElementById("userModal"));
      const counterModal = new bootstrap.Modal(document.getElementById("counterModal"));
      const serviceModal = new bootstrap.Modal(document.getElementById("serviceModal"));
      const youtubeModal = new bootstrap.Modal(document.getElementById("youtubeModal"));

      let ytEditingId = null;
      
      function toggleMediaTypeFields() {
        const mediaType = document.getElementById("ytMediaType").value;
        const isSlide = mediaType === "slide";
        document.getElementById("ytYouTubeFields").style.display = isSlide ? "none" : "block";
        document.getElementById("ytSlideFields").style.display = isSlide ? "block" : "none";
      }
      
      function fileToBase64(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
      }
      
      document.getElementById("ytMediaType").addEventListener("change", toggleMediaTypeFields);
      document.getElementById("ytSlideFile").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) {
          document.getElementById("ytSlidePreview").style.display = "none";
          return;
        }
        try {
          const base64 = await fileToBase64(file);
          document.getElementById("ytSlidePreviewImg").src = base64;
          document.getElementById("ytSlidePreview").style.display = "block";
        } catch (e) {
          console.error("Error reading file:", e);
          swalErr("Erro", "N√£o foi poss√≠vel ler o arquivo selecionado.");
        }
      });
      
      async function openYouTubeModalForNew() {
        ytEditingId = null;
        document.getElementById("ytModalTitle").textContent = "Novo item da playlist";
        document.getElementById("ytMediaType").value = "youtube";
        document.getElementById("ytUrl").value = "";
        document.getElementById("ytDesc").value = "";
        document.getElementById("ytPos").value = "1";
        document.getElementById("ytEnabled").checked = true;
        document.getElementById("ytSlideTitle").value = "";
        document.getElementById("ytSlideFile").value = "";
        document.getElementById("ytSlideDuration").value = "10";
        document.getElementById("ytSlidePreview").style.display = "none";
        toggleMediaTypeFields();
        youtubeModal.show();
      }

      async function openYouTubeModalForEdit(id) {
        ytEditingId = id;
        document.getElementById("ytModalTitle").textContent = "Editar item da playlist";
        const rows = await api("/tenant/youtube", { headers: authHeaders() });
        const v = (rows || []).find(x => x.id === id);
        if (!v) throw new Error("Item n√£o encontrado");
        
        const mediaType = (v.media_type || "youtube").toLowerCase();
        document.getElementById("ytMediaType").value = mediaType;
        document.getElementById("ytDesc").value = v.description || "";
        document.getElementById("ytPos").value = String(v.position ?? 1);
        document.getElementById("ytEnabled").checked = !!v.enabled;
        
        if (mediaType === "slide") {
          document.getElementById("ytSlideTitle").value = v.title || "";
          document.getElementById("ytSlideFile").value = ""; // File input cannot be pre-filled
          document.getElementById("ytSlideDuration").value = String(v.slide_duration_seconds || 10);
          if (v.image_url) {
            const imgUrl = v.image_url.startsWith("/") ? `${window.location.protocol}//${window.location.hostname}:7071${v.image_url}` : v.image_url;
            document.getElementById("ytSlidePreviewImg").src = imgUrl;
            document.getElementById("ytSlidePreview").style.display = "block";
          }
        } else {
          document.getElementById("ytUrl").value = v.url || "";
        }
        
        toggleMediaTypeFields();
        youtubeModal.show();
      }

      document.getElementById("btnOpenYouTubeModal").addEventListener("click", () => {
        openYouTubeModalForNew().catch(e => swalErr("Erro", String(e)));
      });

      document.getElementById("btnSaveYouTube").addEventListener("click", async () => {
        try {
          const mediaType = document.getElementById("ytMediaType").value;
          const payload = {
            media_type: mediaType,
            description: document.getElementById("ytDesc").value,
            position: Number(document.getElementById("ytPos").value || "1"),
            enabled: document.getElementById("ytEnabled").checked,
          };
          
          if (mediaType === "youtube") {
            payload.url = document.getElementById("ytUrl").value;
            payload.refetch_metadata = true;
            if (!payload.url || !payload.url.trim()) throw new Error("Informe a URL do YouTube.");
          } else {
            // Slide
            payload.title = document.getElementById("ytSlideTitle").value || "Slide";
            payload.slide_duration_seconds = Number(document.getElementById("ytSlideDuration").value || "10");
            
            const fileInput = document.getElementById("ytSlideFile");
            
            if (fileInput.files && fileInput.files.length > 0) {
              // Upload file as base64
              payload.image_base64 = await fileToBase64(fileInput.files[0]);
            } else {
              if (ytEditingId) {
                // Editing: allow keeping existing image (no new file selected)
                // Don't send image_base64 or image_url, backend will keep existing
              } else {
                throw new Error("Selecione uma imagem para o slide.");
              }
            }
          }

          if (ytEditingId) {
            await api(`/tenant/youtube/${ytEditingId}`, { method: "PUT", headers: authHeaders(), body: JSON.stringify(payload) });
            swalOk("Salvo", "Item atualizado.");
          } else {
            await api("/tenant/youtube", { method: "POST", headers: authHeaders(), body: JSON.stringify(payload) });
            swalOk("Salvo", "Item cadastrado.");
          }

          try { youtubeModal.hide(); } catch {}
          await refreshYouTube();
        } catch (e) {
          swalErr("Erro", String(e));
        }
      });

      document.body.addEventListener("click", async (ev) => {
        const t = ev.target;
        if (!(t instanceof HTMLElement)) return;

        const editId = t.getAttribute("data-edit-yt");
        if (editId) {
          try { await openYouTubeModalForEdit(editId); } catch (e) { swalErr("Erro", String(e)); }
          return;
        }

        const delId = t.getAttribute("data-del-yt");
        if (delId) {
          const ok = await swalConfirm("Excluir v√≠deo?", "Esta a√ß√£o remove o v√≠deo da playlist.");
          if (!ok.isConfirmed) return;
          try {
            await api(`/tenant/youtube/${delId}`, { method: "DELETE", headers: authHeaders() });
            swalOk("Exclu√≠do", "V√≠deo removido.");
            await refreshYouTube();
          } catch (e) {
            swalErr("Erro", String(e));
          }
          return;
        }

        const togId = t.getAttribute("data-toggle-yt");
        if (togId) {
          const curEnabled = t.getAttribute("data-enabled") === "1";
          const newEnabled = !curEnabled;
          try {
            await api(`/tenant/youtube/${togId}/toggle`, { method: "POST", headers: authHeaders(), body: JSON.stringify({ enabled: newEnabled }) });
            await refreshYouTube();
          } catch (e) {
            swalErr("Erro", String(e));
          }
          return;
        }
      });


      document.getElementById("btnOpenUserModal").addEventListener("click", async () => {
        editingUserId = null;
        document.getElementById("userModalTitle").textContent = "Novo operador";
        document.getElementById("userModalSubtitle").textContent = "Crie um usu√°rio para realizar chamadas.";
        document.getElementById("userModalAlert").textContent = "Antes de confirmar: defina uma senha forte e mantenha o email correto para login.";
        document.getElementById("userModalAlert").classList.remove("d-none");
        document.getElementById("uEmail").value = "";
        document.getElementById("uName").value = "";
        document.getElementById("uPass").value = "";
        document.getElementById("uPass").placeholder = "m√≠n. 6 caracteres";
        document.getElementById("uRole").value = "operator";
        document.getElementById("uActive").checked = true;
        if (!lastServices.length) {
          try { lastServices = await api("/tenant/services", { headers: authHeaders() }); } catch {}
        }
        renderServiceCheckboxes(lastServices, []);
        userModal.show();
      });
      document.getElementById("usersTable").addEventListener("click", async (e) => {
        const btn = e.target.closest("[data-edit-user]");
        if (!btn) return;
        const id = (btn.getAttribute("data-edit-user") || "").trim();
        const user = lastUsers.find((u) => u.id === id);
        if (!user) return;
        editingUserId = id;
        document.getElementById("userModalTitle").textContent = "Editar operador";
        document.getElementById("userModalSubtitle").textContent = "Altere os dados. Deixe a senha em branco para manter a atual.";
        document.getElementById("userModalAlert").textContent = "Altere apenas o que precisar. Senha em branco mant√©m a atual.";
        document.getElementById("userModalAlert").classList.remove("d-none");
        document.getElementById("uEmail").value = user.email || "";
        document.getElementById("uName").value = user.full_name || "";
        document.getElementById("uRole").value = user.role === "admin" ? "admin" : "operator";
        document.getElementById("uPass").value = "";
        document.getElementById("uPass").placeholder = "deixe em branco para manter";
        document.getElementById("uActive").checked = Boolean(user.active);
        if (!lastServices.length) {
          try { lastServices = await api("/tenant/services", { headers: authHeaders() }); } catch {}
        }
        renderServiceCheckboxes(lastServices, user.service_ids || []);
        userModal.show();
      });
      document.getElementById("btnSaveUser").addEventListener("click", async () => {
        const email = String(document.getElementById("uEmail").value || "").trim();
        const full_name = String(document.getElementById("uName").value || "").trim();
        const password = String(document.getElementById("uPass").value || "").trim();
        const role = document.getElementById("uRole").value || "operator";
        const active = Boolean(document.getElementById("uActive").checked);
        const service_ids = collectCheckedServiceIds();
        if (!email) {
          swalErr("Operador", "Email √© obrigat√≥rio.");
          return;
        }
        if (editingUserId) {
          const payload = { email, full_name, role, active, service_ids };
          if (password) payload.password = password;
          await api(`/tenant/users/${editingUserId}`, { method: "PUT", headers: authHeaders(), body: JSON.stringify(payload) });
          userModal.hide();
          editingUserId = null;
          await refreshUsers();
          swalOk("Operador atualizado", "Dados salvos.");
        } else {
          if (!password) {
            swalErr("Operador", "Senha √© obrigat√≥ria para novo usu√°rio.");
            return;
          }
          await api("/tenant/users", { method: "POST", headers: authHeaders(), body: JSON.stringify({ email, full_name, password, role, active, service_ids }) });
          userModal.hide();
          await refreshUsers();
          swalOk("Operador criado", "Usu√°rio cadastrado.");
        }
      });

      document.getElementById("btnOpenCounterModal").addEventListener("click", () => {
        document.getElementById("cName").value = "";
        document.getElementById("cActive").checked = true;
        counterModal.show();
      });
      document.getElementById("btnSaveCounter").addEventListener("click", async () => {
        const payload = {
          name: document.getElementById("cName").value,
          active: Boolean(document.getElementById("cActive").checked),
        };
        if (!String(payload.name || "").trim()) {
          swalErr("Guich√™", "Informe o nome.");
          return;
        }
        await api("/tenant/counters", { method: "POST", headers: authHeaders(), body: JSON.stringify(payload) });
        counterModal.hide();
        await refreshCounters();
        swalOk("Guich√™ criado", "Guich√™ cadastrado.");
      });

      document.getElementById("btnOpenServiceModal").addEventListener("click", () => {
        document.getElementById("sName").value = "";
        document.getElementById("sPriority").value = "normal";
        document.getElementById("sActive").checked = true;
        serviceModal.show();
      });
      document.getElementById("btnSaveService").addEventListener("click", async () => {
        const payload = {
          name: document.getElementById("sName").value,
          priority_mode: document.getElementById("sPriority").value,
          active: Boolean(document.getElementById("sActive").checked),
        };
        if (!String(payload.name || "").trim()) {
          swalErr("Servi√ßo", "Informe o nome.");
          return;
        }
        await api("/tenant/services", { method: "POST", headers: authHeaders(), body: JSON.stringify(payload) });
        serviceModal.hide();
        await refreshServices();
        swalOk("Servi√ßo criado", "Servi√ßo cadastrado.");
      });

      // Announcements modal (SCart-style)
      const annModalEl = document.getElementById("announcementModal");
      const annModal = new bootstrap.Modal(annModalEl);
      document.getElementById("btnOpenAnnouncementModal").addEventListener("click", () => {
        document.getElementById("annMessage").value = "";
        document.getElementById("annPos").value = "1";
        document.getElementById("annEnabled").checked = true;
        annModal.show();
      });
      document.getElementById("btnSaveAnnouncement").addEventListener("click", async () => {
        const payload = {
          message: document.getElementById("annMessage").value,
          position: Number(document.getElementById("annPos").value || 1),
          enabled: Boolean(document.getElementById("annEnabled").checked),
        };
        if (!payload.message.trim()) {
          swalErr("Aviso", "Digite uma mensagem.");
          return;
        }
        await api("/tenant/announcements", { method: "POST", headers: authHeaders(), body: JSON.stringify(payload) });
        annModal.hide();
        await refreshAnnouncements();
        swalOk("Aviso salvo", "Vai aparecer na TV em sequ√™ncia.");
      });

      // TV Settings buttons
      document.getElementById("btnRefreshTVSettings").addEventListener("click", refreshTVSettings);
      document.getElementById("btnResetHistory").addEventListener("click", async () => {
        const ok = await Swal.fire({
          title: "Resetar hist√≥rico?",
          text: "Todas as senhas e chamadas ser√£o apagadas. A TV e o painel ficar√£o vazios.",
          icon: "warning",
          showCancelButton: true,
          confirmButtonColor: "#e53e3e",
          cancelButtonText: "Cancelar",
          confirmButtonText: "Sim, resetar",
        });
        if (!ok.isConfirmed) return;
        try {
          const r = await api("/tenant/reset-history", { method: "POST", headers: authHeaders() });
          await Swal.fire({
            icon: "success",
            title: "Hist√≥rico resetado",
            text: `${r.deleted_tickets ?? 0} senhas e ${r.deleted_calls ?? 0} chamadas removidas.`,
          });
          await refreshDashboard();
        } catch (e) {
          swalErr("Erro", String(e));
        }
      });
      document.getElementById("btnThemeToggle").addEventListener("click", async () => {
        currentTVSettings.tv_theme = currentTVSettings.tv_theme === "dark" ? "light" : "dark";
        updateTVSettingsUI();
        await saveTVSettings();
      });
      document.getElementById("btnAudioToggle").addEventListener("click", async () => {
        currentTVSettings.tv_audio_enabled = !currentTVSettings.tv_audio_enabled;
        updateTVSettingsUI();
        await saveTVSettings();
      });
      const selectCallSound = document.getElementById("selectCallSound");
      if (selectCallSound) {
        selectCallSound.addEventListener("change", async () => {
          currentTVSettings.tv_call_sound = selectCallSound.value;
          await saveTVSettings();
        });
      }
      const btnTestCallSound = document.getElementById("btnTestCallSound");
      if (btnTestCallSound && selectCallSound) {
        btnTestCallSound.addEventListener("click", () => {
          const filename = selectCallSound.value;
          if (!filename) return;
          const url = `${EDGE_BASE}/api/sounds/${encodeURIComponent(filename)}`;
          const audio = new Audio(url);
          btnTestCallSound.disabled = true;
          btnTestCallSound.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
          const done = () => { btnTestCallSound.disabled = false; btnTestCallSound.textContent = "Testar"; };
          audio.onended = done;
          audio.onerror = done;
          audio.play().catch(done);
        });
      }
      document.getElementById("btnVideoAudioToggle").addEventListener("click", async () => {
        currentTVSettings.tv_video_muted = !currentTVSettings.tv_video_muted;
        updateTVSettingsUI();
        await saveTVSettings();
      });
      document.getElementById("btnVideoPlaybackToggle").addEventListener("click", async () => {
        currentTVSettings.tv_video_paused = !currentTVSettings.tv_video_paused;
        updateTVSettingsUI();
        await saveTVSettings();
      });
      document.getElementById("btnTtsToggle").addEventListener("click", async () => {
        currentTVSettings.tts_enabled = !currentTVSettings.tts_enabled;
        updateTVSettingsUI();
        await saveTVSettings();
      });
      const selectTtsVoice = document.getElementById("selectTtsVoice");
      if (selectTtsVoice) {
        selectTtsVoice.addEventListener("change", async () => {
          currentTVSettings.tts_voice = selectTtsVoice.value;
          await saveTVSettings();
        });
      }
      const sliderTtsSpeed = document.getElementById("sliderTtsSpeed");
      if (sliderTtsSpeed) {
        sliderTtsSpeed.addEventListener("input", () => {
          document.getElementById("labelTtsSpeed").textContent = `${Number(sliderTtsSpeed.value).toFixed(2)}√ó`;
        });
        sliderTtsSpeed.addEventListener("change", async () => {
          currentTVSettings.tts_speed = parseFloat(sliderTtsSpeed.value);
          await saveTVSettings();
        });
      }
      const sliderTtsVolume = document.getElementById("sliderTtsVolume");
      if (sliderTtsVolume) {
        sliderTtsVolume.addEventListener("input", () => {
          document.getElementById("labelTtsVolume").textContent = `${Number(sliderTtsVolume.value).toFixed(1)}√ó`;
        });
        sliderTtsVolume.addEventListener("change", async () => {
          currentTVSettings.tts_volume = parseFloat(sliderTtsVolume.value);
          await saveTVSettings();
        });
      }
      const btnTestTtsVoice = document.getElementById("btnTestTtsVoice");
      if (btnTestTtsVoice) {
        btnTestTtsVoice.addEventListener("click", () => {
          const voice = selectTtsVoice?.value || "pf_dora";
          const speed = sliderTtsSpeed?.value || 0.85;
          const volume = sliderTtsVolume?.value || 1.0;
          const url = `${EDGE_BASE}/api/tts/call?ticket_code=A001&service_name=Caixas+de+Pagamento` +
            `&voice=${encodeURIComponent(voice)}&speed=${speed}&volume=${volume}`;
          const audio = new Audio(url);
          btnTestTtsVoice.disabled = true;
          btnTestTtsVoice.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
          const done = () => { btnTestTtsVoice.disabled = false; btnTestTtsVoice.textContent = "Testar"; };
          audio.onended = done;
          audio.onerror = done;
          audio.play().catch(done);
        });
      }

      // Branding upload (logo)
      function fileToDataUrl(file) {
        return new Promise((resolve, reject) => {
          const r = new FileReader();
          r.onerror = () => reject(new Error("Falha ao ler arquivo"));
          r.onload = () => resolve(String(r.result || ""));
          r.readAsDataURL(file);
        });
      }
      document.getElementById("logoFile").addEventListener("change", async (ev) => {
        const f = ev.target.files && ev.target.files[0];
        if (!f) return;
        const img = document.getElementById("logoPreview");
        const empty = document.getElementById("logoPreviewEmpty");
        const dataUrl = await fileToDataUrl(f);
        img.src = dataUrl;
        img.style.display = "block";
        empty.style.display = "none";
      });
      document.getElementById("btnUploadLogo").addEventListener("click", async () => {
        const input = document.getElementById("logoFile");
        const f = input.files && input.files[0];
        if (!f) { swalErr("Logo", "Selecione um arquivo primeiro."); return; }
        const dataUrl = await fileToDataUrl(f);
        await api("/tenant/logo", { method: "POST", headers: authHeaders(), body: JSON.stringify({ logo_base64: dataUrl }) });
        swalOk("Logo salva", "A TV vai atualizar no pr√≥ximo refresh/poll.");
        await refreshBrandingPreview();
      });
      document.getElementById("btnClearLogo").addEventListener("click", async () => {
        const ok = await swalConfirm("Remover logo?", "A TV voltar√° a usar o fallback.");
        if (!ok.isConfirmed) return;
        await api("/tenant/logo", { method: "POST", headers: authHeaders(), body: JSON.stringify({ logo_base64: "data:," }) });
        await refreshBrandingPreview();
        swalOk("Logo removida", "Fallback ser√° usado.");
      });

      // Delete announcement (event delegation)
      document.addEventListener("click", async (ev) => {
        const btn = ev.target?.closest?.("[data-del-ann]");
        if (!btn) return;
        const id = btn.getAttribute("data-del-ann");
        const ok = await swalConfirm("Excluir aviso?", "Essa a√ß√£o remove o aviso do rodap√©.");
        if (!ok.isConfirmed) return;
        await api("/tenant/announcements/delete", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id }) });
        await refreshAnnouncements();
        swalOk("Exclu√≠do", "Aviso removido.");
      });

      // Delete user/counter/service (event delegation)
      document.addEventListener("click", async (ev) => {
        const u = ev.target?.closest?.("[data-del-user]");
        if (u) {
          const id = u.getAttribute("data-del-user");
          const ok = await swalConfirm("Excluir operador?", "Essa a√ß√£o remove o operador do tenant.");
          if (!ok.isConfirmed) return;
          await api("/tenant/users/delete", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id }) });
          await refreshUsers();
          swalOk("Exclu√≠do", "Operador removido.");
          return;
        }
        const c = ev.target?.closest?.("[data-del-counter]");
        if (c) {
          const id = c.getAttribute("data-del-counter");
          const ok = await swalConfirm("Excluir guich√™?", "Essa a√ß√£o remove o guich√™ do tenant.");
          if (!ok.isConfirmed) return;
          await api("/tenant/counters/delete", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id }) });
          await refreshCounters();
          swalOk("Exclu√≠do", "Guich√™ removido.");
          return;
        }
        const s = ev.target?.closest?.("[data-del-service]");
        if (s) {
          const id = s.getAttribute("data-del-service");
          const ok = await swalConfirm("Excluir servi√ßo?", "Essa a√ß√£o remove o servi√ßo do tenant.");
          if (!ok.isConfirmed) return;
          try {
            await api("/tenant/services/delete", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id }) });
            await refreshServices();
            swalOk("Exclu√≠do", "Servi√ßo removido.");
          } catch (e) {
            const msg = e?.message || String(e);
            const detail = msg.includes("detail") ? JSON.parse(msg.slice(msg.indexOf("{"))).detail : msg;
            Swal.fire({ icon: "warning", title: "N√£o foi poss√≠vel excluir", text: detail });
          }
        }
      });

      // Toggle user/counter/service/announcement (event delegation)
      document.addEventListener("click", async (ev) => {
        // Toggle user
        const tu = ev.target?.closest?.("[data-toggle-user]");
        if (tu) {
          const id = tu.getAttribute("data-toggle-user");
          const isActive = tu.getAttribute("data-active") === "1";
          const newActive = !isActive;
          await api("/tenant/users/toggle", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id, active: newActive }) });
          await refreshUsers();
          swalOk(newActive ? "Ativado" : "Desativado", `Operador ${newActive ? "ativado" : "desativado"}.`);
          return;
        }
        // Toggle counter
        const tc = ev.target?.closest?.("[data-toggle-counter]");
        if (tc) {
          const id = tc.getAttribute("data-toggle-counter");
          const isActive = tc.getAttribute("data-active") === "1";
          const newActive = !isActive;
          await api("/tenant/counters/toggle", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id, active: newActive }) });
          await refreshCounters();
          swalOk(newActive ? "Ativado" : "Desativado", `Guich√™ ${newActive ? "ativado" : "desativado"}.`);
          return;
        }
        // Toggle service
        const ts = ev.target?.closest?.("[data-toggle-service]");
        if (ts) {
          const id = ts.getAttribute("data-toggle-service");
          const isActive = ts.getAttribute("data-active") === "1";
          const newActive = !isActive;
          await api("/tenant/services/toggle", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id, active: newActive }) });
          await refreshServices();
          swalOk(newActive ? "Ativado" : "Desativado", `Servi√ßo ${newActive ? "ativado" : "desativado"}.`);
          return;
        }
        // Toggle announcement
        const ta = ev.target?.closest?.("[data-toggle-ann]");
        if (ta) {
          const id = ta.getAttribute("data-toggle-ann");
          const isEnabled = ta.getAttribute("data-enabled") === "1";
          const newEnabled = !isEnabled;
          await api("/tenant/announcements/toggle", { method: "POST", headers: authHeaders(), body: JSON.stringify({ id, enabled: newEnabled }) });
          await refreshAnnouncements();
          swalOk(newEnabled ? "Ativado" : "Desativado", `Aviso ${newEnabled ? "ativado" : "desativado"}.`);
          return;
        }
      });

      // Auto-login if token exists
      (async () => {
        const t = getToken();
        const modalEl = document.getElementById("loginModal");
        const loginModal = new bootstrap.Modal(modalEl, { backdrop: "static", keyboard: false });
        if (!t) {
          loginModal.show();
          return;
        }
        try {
          await afterLogin();
        } catch {
          setToken("");
          loginModal.show();
        }
      })();

      // ‚îÄ‚îÄ Monitor ao Vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      let _liveMonitorInterval = null;

      function fmtSeconds(sec) {
        if (!sec || sec <= 0) return "‚Äî";
        const m = Math.floor(sec / 60);
        const s = Math.round(sec % 60);
        return m > 0 ? `${m}m ${s}s` : `${s}s`;
      }

      async function loadLiveMonitor() {
        try {
          const d = await api("/tenant/dashboard/live", { headers: authHeaders() });

          document.getElementById("lmQueuePref").textContent = d.queue?.preferential ?? "‚Äî";
          document.getElementById("lmQueueNorm").textContent = d.queue?.normal ?? "‚Äî";
          document.getElementById("lmInService").textContent = d.today?.in_service ?? "‚Äî";
          document.getElementById("lmAttended").textContent = d.today?.attended ?? "‚Äî";
          document.getElementById("lmDesistentes").textContent = d.today?.desistentes ?? "‚Äî";
          document.getElementById("lmAvgWait").textContent = fmtSeconds(d.avg_wait_seconds);
          document.getElementById("lmAvgService").textContent = fmtSeconds(d.avg_service_seconds);

          const now = new Date().toLocaleTimeString("pt-BR", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
          document.getElementById("liveMonitorUpdatedAt").textContent = `√öltima atualiza√ß√£o: ${now}`;

          // Gr√°fico hor√°rio
          const hourly = d.hourly || [];
          const chart = document.getElementById("lmHourlyChart");
          const empty = document.getElementById("lmHourlyEmpty");
          if (!hourly.length) {
            chart.innerHTML = "";
            empty.classList.remove("d-none");
          } else {
            empty.classList.add("d-none");
            const maxVal = Math.max(1, ...hourly.map(h => h.attended + h.desistentes));
            chart.innerHTML = hourly.map(h => {
              const total = h.attended + h.desistentes;
              const pct = Math.round((total / maxVal) * 100);
              const pctAtt = total ? Math.round((h.attended / total) * 100) : 0;
              return `<div class="dash-chart-bar-wrap" title="${h.hour}: ${h.attended} atend., ${h.desistentes} desist.">
                <div class="dash-chart-bar" style="height:${pct}%; background: linear-gradient(to top, #e53e3e ${100 - pctAtt}%, #1f9d55 ${100 - pctAtt}%)"></div>
                <span class="small" style="font-size:0.65rem;">${h.hour}</span>
              </div>`;
            }).join("");
          }
        } catch (e) {
          document.getElementById("liveMonitorUpdatedAt").textContent = "Erro ao carregar dados.";
        }
      }

      const liveMonitorModal = new bootstrap.Modal(document.getElementById("liveMonitorModal"));
      document.getElementById("liveMonitorModal").addEventListener("shown.bs.modal", () => {
        loadLiveMonitor();
        _liveMonitorInterval = setInterval(loadLiveMonitor, 10_000);
      });
      document.getElementById("liveMonitorModal").addEventListener("hidden.bs.modal", () => {
        clearInterval(_liveMonitorInterval);
        _liveMonitorInterval = null;
      });
      document.getElementById("btnOpenLiveMonitor")?.addEventListener("click", () => liveMonitorModal.show());
      document.getElementById("btnRefreshLiveMonitor")?.addEventListener("click", () => loadLiveMonitor());
      // ‚îÄ‚îÄ fim Monitor ao Vivo ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

      // Periodic dashboard refresh (while authenticated)
      setInterval(() => {
        if (!getToken()) return;
        refreshDashboard().catch(() => {});
      }, 30_000);
    </script>
  </body>
</html>

